' === ThisWorkbook 模块 ===
Option Explicit

Private Sub Workbook_Open()
    BeautifySheet
End Sub



' === Module1 模块 ===
Option Explicit

Public Sub BeautifySheet()
    Dim ws As Worksheet, shp As Shape
    Dim tbl As Range, cell As Range
    Dim rowHeights() As Double, colWidths() As Double
    Dim maxRow As Long, maxCol As Long
    Dim r As Long, c As Long
    Dim targetW As Double, padH As Double, padV As Double
    Dim headRow As Long

    ' 参数设置
    targetW = 90     ' 统一图片宽度（pt）
    padH = 8         ' 左右留白
    padV = 6         ' 上下留白

    For Each ws In ThisWorkbook.Worksheets
        
        ' 找出表格区域
        On Error Resume Next
        Set tbl = ws.Range("A1").CurrentRegion
        On Error GoTo 0
        
        If Not tbl Is Nothing Then
            headRow = tbl.Row
            tbl.Columns.AutoFit
            maxRow = ws.Rows.Count
            maxCol = ws.Columns.Count
            
            ' 初始化数组
            ReDim rowHeights(1 To maxRow)
            ReDim colWidths(1 To maxCol)
            
            ' === 1) 计算需求 ===
            For Each shp In ws.Shapes
                If shp.Type = msoPicture Then
                    shp.LockAspectRatio = msoTrue
                    shp.Width = targetW
                    
                    Set cell = shp.TopLeftCell
                    r = cell.Row: c = cell.Column
                    
                    ' 行高需求
                    If r > headRow Then
                        If rowHeights(r) < shp.Height + padV * 2 Then
                            rowHeights(r) = shp.Height + padV * 2
                        End If
                    End If
                    
                    ' 列宽需求
                    If colWidths(c) < shp.Width + padH * 2 Then
                        colWidths(c) = shp.Width + padH * 2
                    End If
                End If
            Next shp
            
            ' === 2) 应用需求 ===
            For r = 1 To maxRow
                If rowHeights(r) > 0 Then
                    ws.Rows(r).rowHeight = rowHeights(r)
                End If
            Next r
            
            For c = 1 To maxCol
                If colWidths(c) > 0 Then
                    Call SetColumnWidthPoints(ws, c, colWidths(c))
                End If
            Next c
            
            ' === 3) 调整图片居中 ===
            For Each shp In ws.Shapes
                If shp.Type = msoPicture Then
                    Set cell = shp.TopLeftCell
                    shp.Top = cell.Top + (cell.Height - shp.Height) / 2
                    shp.Left = cell.Left + (cell.Width - shp.Width) / 2
                End If
            Next shp
            
            ' === 4) 美化边框 ===
            With tbl.Borders
                .LineStyle = xlContinuous
                .Weight = xlThin
                .Color = RGB(200, 200, 200)
            End With
        End If
    Next ws
End Sub

' 列宽精调函数 (Mac 也能用)
Private Sub SetColumnWidthPoints(ByVal ws As Worksheet, ByVal colIndex As Long, ByVal targetPts As Double)
    Dim col As Range, i As Long, currentPts As Double, cw As Double
    Set col = ws.Columns(colIndex)
    
    If targetPts <= 0 Then Exit Sub
    
    currentPts = col.Width
    If currentPts = 0 Then Exit Sub
    
    cw = col.ColumnWidth * (targetPts / currentPts)
    col.ColumnWidth = cw
    
    For i = 1 To 6
        currentPts = col.Width
        If Abs(currentPts - targetPts) <= 0.5 Then Exit For
        cw = col.ColumnWidth * (targetPts / currentPts)
        col.ColumnWidth = cw
    Next i
End Sub

