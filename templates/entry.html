<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>录入 - 商品信息管理</title>
            <link href="/static/lib/bootstrap5.1.3/bootstrap.min.css" rel="stylesheet" />
            <link href="/static/lib/bootstrap-icons/bootstrap-icons.min.css" rel="stylesheet" />
            <link href="/static/lib/tabulator/tabulator.min.css" rel="stylesheet" />
        <style>
            body { padding-top: 64px; }
            .product-image { max-width: 70px; max-height: 70px; object-fit: cover; cursor: pointer; }
            /* 顶部导航：居中+高亮 */
            .navbar .navbar-nav { gap: 1.25rem; }
            .navbar .nav-link { color: rgba(255,255,255,.7); font-weight: 600; }
            .navbar .nav-link.active {
                color: #fff !important;
                background-color: #0d6efd;
                border-radius: .5rem;
                padding: .25rem .85rem;
                box-shadow: 0 0 .6rem rgba(13,110,253,.55);
            }
            .navbar .nav-link:hover { color: #fff; }
            /* 列表不换行，靠外层 .table-responsive 横向滚动 */
            .table-nowrap th, .table-nowrap td { white-space: nowrap; }
            /* 可编辑行高亮，与 search_edit 保持一致 */
            .changed { background-color: #e7f5ff !important; }
            /* 统一缩略图样式（与 search_edit 一致） */
            .thumb-fixed { width: 80px; height: 60px; object-fit: contain; border-radius: 4px; cursor: pointer; background-color: #fff; display: inline-block; }
            .tabulator-cell .btn { padding: .1rem .4rem; font-size: .75rem; }
            /* 图片弹框样式（与 search_edit 保持一致） */
            .image-modal-img { max-width: 100%; height: auto; display: block; margin: 0 auto; }
            .image-modal-body { text-align: center; min-height: 200px; display: flex; align-items: center; justify-content: center; }
            /* 表单：同一行显示，标签右对齐，输入统一宽度 */
            @media (min-width: 768px){
                #productForm .row.g-3 > .col-md-3 { display: flex; align-items: center; gap: .5rem; }
                #productForm .row.g-3 > .col-md-3 > label.form-label { width: 6.5rem; text-align: right; margin-bottom: 0; white-space: nowrap; }
                #productForm .row.g-3 > .col-md-3 > .form-control { flex: 1 1 auto; }
                #productForm .row.g-3 > .col-md-3 > .invalid-feedback { margin-left: 6.5rem; }
            }
        </style>
    </head>
    <body class="bg-light">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">商品管理</a>
                <div class="navbar-nav mx-auto flex-row">
                    <a class="nav-link" href="/search">查询/导出</a>
                    <a class="nav-link" href="/search-edit">查询/编辑</a>
                    <a class="nav-link active" aria-current="page" href="/entry">录入</a>
                    <a class="nav-link" href="/auth/users">用户管理</a>
                </div>
                <div class="d-flex align-items-center">
                    <span class="text-white-50 me-3">{{ (session.get('real_name') or session.get('username')) or '' }}</span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">退出</button>
                </div>
            </div>
        </nav>

        <div class="container py-4">
            <div class="row g-3">
                <div class="col-12">
                    <div class="bg-white rounded shadow-sm p-3">
                        <form id="productForm" enctype="multipart/form-data" novalidate>
                            <div class="row g-3">
                                <!-- 第1行：单据日期、客户名称、品名规格、单位 -->
                                <div class="col-md-3">
                                    <label class="form-label">单据日期 <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="doc_date" name="doc_date" required />
                                    <div class="invalid-feedback">单据日期不能为空</div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">客户名称 <span class="text-danger">*</span></label>
                                    <input class="form-control" id="name" name="name" required />
                                    <div class="invalid-feedback">客户名称不能为空</div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">品名规格 <span class="text-danger">*</span></label>
                                    <input class="form-control" id="product_desc" name="product_desc" required />
                                    <div class="invalid-feedback">品名规格不能为空</div>
                                </div>

                                 <div class="col-md-3">
                                    <label class="form-label">数量 <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="quantity" name="quantity" min="0" value="0" required />
                                    <div class="invalid-feedback">数量必须是大于0的数字</div>
                                </div>
                                <!-- 第2行：单价、数量、单价折扣率、折后单价 -->

                                <div class="col-md-3">
                                    <label class="form-label">单位</label>
                                    <input class="form-control" id="spec" name="spec" />
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label">单价 </label>
                                    <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" value="0" required />
                                </div>
                               
                                <div class="col-md-3">
                                    <label class="form-label">单价折扣率(%)</label>
                                    <input type="number" class="form-control" id="unit_discount_rate" name="unit_discount_rate" step="0.01" value="100" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">折后单价</label>
                                    <input type="number" class="form-control" id="unit_price_discounted" name="unit_price_discounted" step="0.01" readonly />
                                </div>

                                <!-- 第3行：运费、整单折扣率、折后金额、应收款 -->
                                <div class="col-md-3">
                                    <label class="form-label">运费</label>
                                    <input type="number" class="form-control" id="freight" name="freight" step="0.01" value="0" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">整单折扣率(%)</label>
                                    <input type="number" class="form-control" id="order_discount_rate" name="order_discount_rate" step="0.01" value="100" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">折后金额</label>
                                    <input type="number" class="form-control" id="amount_discounted" name="amount_discounted" step="0.01" readonly />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">应收款</label>
                                    <input type="number" class="form-control" id="receivable" name="receivable" step="0.01" readonly />
                                </div>

                                <!-- 第4行：结算账户、本次收款、已收款、尾款 -->
                                <div class="col-md-3">
                                    <label class="form-label">结算账户</label>
                                    <input class="form-control" id="settlement_account" name="settlement_account" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">已收款</label>
                                    <input type="number" class="form-control" id="paid_total" name="paid_total" step="0.01" value="0" />
                                </div>
                                
                                <div class="col-md-3">
                                    <label class="form-label">备注</label>
                                    <input class="form-control" id="remark" name="remark" />
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label">尾款</label>
                                    <input type="number" class="form-control" id="balance" name="balance" step="0.01" readonly />
                                </div>

                                <!-- 第5行：备注、说明、图片、营业员 -->
                          
                                <div class="col-md-3">
                                    <label class="form-label">说明</label>
                                    <input class="form-control" id="description" name="description" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">图片</label>
                                    <input type="file" class="form-control" id="image" name="image" accept="image/*" />
                                </div>
                            </div>
                            <div class="mt-3">
                                <button type="submit" class="btn btn-primary"><i class="bi bi-plus"></i> 添加</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="clearForm()"><i class="bi bi-eraser"></i> 清空</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="col-12">
                    <div class="bg-white rounded shadow-sm p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0"><i class="bi bi-list"></i> 今日录入（可编辑）</h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="refreshToday()"><i class="bi bi-arrow-clockwise"></i> 刷新</button>
                        </div>
                        <div id="todayGrid"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 编辑模态框复用 -->
        <div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-pencil"></i> 修改商品</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form id="editProductForm" enctype="multipart/form-data">
                        <div class="modal-body">
                            <input type="hidden" id="editProductId" name="id" />
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">名称 *</label>
                                    <input class="form-control" id="editName" name="name" required />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">价格 *</label>
                                    <input type="number" step="0.01" min="0" class="form-control" id="editPrice" name="price" required />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">数量 *</label>
                                    <input type="number" min="0" class="form-control" id="editQuantity" name="quantity" required />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">规格</label>
                                    <input class="form-control" id="editSpec" name="spec" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">新图片</label>
                                    <input type="file" class="form-control" id="editImage" name="image" accept="image/*" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">当前图片</label>
                                    <div id="currentImageDisplay" class="border rounded p-2 text-center"><span class="text-muted">无图片</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-check"></i> 保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 查看图片模态框 -->
        <div class="modal fade" id="imageViewModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-image"></i> 商品图片</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img id="fullSizeImage" src="" alt="商品原图" class="img-fluid" style="max-height: 80vh" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        <a id="downloadImageLink" href="" download class="btn btn-primary"><i class="bi bi-download"></i> 下载图片</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图片查看/编辑弹框（与 search_edit 一致） -->
        <div class="modal fade" id="imageViewerModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">图片预览</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body image-modal-body">
                        <img id="imageModalPreview" class="image-modal-img" alt="预览" />
                        <div id="imageModalEmpty" class="text-muted d-none">当前无图片</div>
                    </div>
                    <div class="modal-footer">
                        <button id="btnModalAddOrChange" type="button" class="btn btn-primary">添加/更换</button>
                        <button id="btnModalDelete" type="button" class="btn btn-outline-danger">删除</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="messageToast" class="toast" role="alert">
                <div class="toast-header">
                    <strong class="me-auto">系统消息</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>

        <script src="/static/lib/bootstrap5.1.3/bootstrap.bundle.min.js"></script>
        <script src="/static/lib/tabulator/tabulator.min.js"></script>
        <script>
            let todayGrid = null;
            let rowCache = new Map();
            const allowedFields = new Set(['doc_date','customer_name','product_desc','unit','quantity','unit_price','unit_discount_rate','remark','freight','order_discount_rate','paid_total','settlement_account','description']);
            let imageModal = null;
            let currentImageRowId = null;

            document.addEventListener('DOMContentLoaded', function () {
                document.getElementById('productForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    if (!validateForm()) { return; }
                    addProduct();
                });
                document.getElementById('editProductForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    updateProduct();
                });
                // 默认日期
                const dd = document.getElementById('doc_date');
                // 使用本地时区，避免 toISOString 带来的跨天问题
                if (dd) {
                    const now = new Date();
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                    dd.value = now.toISOString().slice(0, 10);
                }
                // 绑定计算
                ['quantity','price','unit_discount_rate','order_discount_rate','freight','paid_total']
                    .forEach(id => document.getElementById(id)?.addEventListener('input', recalc));
                recalc();

                if (typeof Tabulator !== 'undefined') { initTodayGrid(); }

                // 初始化图片弹框
                const modalEl = document.getElementById('imageViewerModal');
                if (modalEl) {
                    imageModal = new bootstrap.Modal(modalEl);
                    document.getElementById('btnModalAddOrChange')?.addEventListener('click', () => {
                        if (currentImageRowId == null) return;
                        triggerImagePick(currentImageRowId);
                    });
                    document.getElementById('btnModalDelete')?.addEventListener('click', () => {
                        if (currentImageRowId == null) return;
                        deleteImageFromModal(currentImageRowId);
                    });
                }

                refreshToday();
            });

            function initTodayGrid(){
                todayGrid = new Tabulator('#todayGrid', {
                    data: [],
                    layout: 'fitData',
                    index: 'id',
                    reactiveData: false,
                    columnDefaults: { headerHozAlign: 'center', vertAlign: 'middle' },
                    columns: [
                        { title: '单据日期', field: 'doc_date', editor: 'input', editorParams: { elementAttributes: { type: 'date' } } },
                        { title: '客户名称', field: 'customer_name', editor: 'input' },
                        { title: '品名规格', field: 'product_desc', editor: 'input' },
                        { title: '单位', field: 'unit', editor: 'input' },
                        { title: '数量', field: 'quantity', editor: 'number' },
                        { title: '单价', field: 'unit_price', editor: 'number', formatter: decimal2 },
                        { title: '单价折扣率(%)', field: 'unit_discount_rate', editor: 'number', formatter: decimal2 },
                        { title: '折后单价', field: 'unit_price_discounted', hozAlign: 'right', formatter: function(cell){ return toFixed2(calcUnitPriceDiscounted(cell.getRow().getData())); } },
                        { title: '金额', field: 'amount', hozAlign: 'right', formatter: function(cell){ return toFixed2(calcAmount(cell.getRow().getData())); } },
                        { title: '图片', field: 'image_path', hozAlign: 'center', headerSort: false, formatter: imageFormatter, cellClick: function(e, cell){ const d = cell.getRow().getData(); if (d && d.id != null) openImageModalById(d.id); } },
                        { title: '备注', field: 'remark', editor: 'input' },
                        { title: '运费', field: 'freight', editor: 'number', formatter: decimal2 },
                        { title: '整单折扣率(%)', field: 'order_discount_rate', editor: 'number', formatter: decimal2 },
                        { title: '折后金额', field: 'amount_discounted', hozAlign: 'right', formatter: function(cell){ return toFixed2(calcAmountDiscounted(cell.getRow().getData())); } },
                        { title: '应收款', field: 'receivable', hozAlign: 'right', formatter: function(cell){ return toFixed2(calcReceivable(cell.getRow().getData())); } },
                        { title: '已收款', field: 'paid_total', editor: 'number', formatter: decimal2 },
                        { title: '尾款', field: 'balance', hozAlign: 'right', formatter: function(cell){ return toFixed2(calcBalance(cell.getRow().getData())); } },
                        { title: '结算账户', field: 'settlement_account', editor: 'input' },
                        { title: '说明', field: 'description', editor: 'input' },
                        { title: '营业员', field: 'salesperson' },
                        { title: '修改时间', field: 'update_time' },
                        { title: '创建时间', field: 'create_time' },
                        { title: '操作', field: 'actions', headerSort: false, hozAlign: 'center', formatter: function(cell){
                            const d = cell.getRow().getData();
                            const id = d && d.id != null ? d.id : '';
                            const name = (d && (d.customer_name || d.name)) || '';
                            return `<button class="btn btn-outline-danger btn-sm" onclick="deleteProduct(${id}, '${(name||'').replace(/'/g, "\\'")}')"><i class='bi bi-trash'></i></button>`;
                        }},
                    ],
                    cellEdited: function(cell){
                        const field = cell.getField();
                        if (!allowedFields.has(field)) return;
                        const row = cell.getRow();
                        const id = row.getIndex();
                        let val = cell.getValue();
                        if (typeof val === 'string' && val.trim() === '') val = null;
                        const oldVal = (typeof cell.getOldValue === 'function') ? cell.getOldValue() : undefined;
                        // 先本地刷新计算列（不等待网络）
                        const base = rowCache.get(id) || {};
                        base[field] = val;
                        rowCache.set(id, base);
                        try { row.reformat(); } catch(e) {}
                        row.getElement().classList.add('changed');
                        // 再异步保存
                        savePartialUpdate(id, { [field]: val })
                          .catch(err => {
                              showMessage('保存失败: ' + (err.message || err), 'error');
                              // 回滚显示与缓存
                              if (oldVal !== undefined) {
                                  const patch = {}; patch[field] = oldVal;
                                  row.update(patch);
                                  const cached = rowCache.get(id) || {};
                                  cached[field] = oldVal;
                                  rowCache.set(id, cached);
                                  try { row.reformat(); } catch(e) {}
                              }
                          });
                    }
                });
            }

            function savePartialUpdate(id, fields){
                return fetch('/product/batch_update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: [{ id, fields }] })
                }).then(r => r.json()).then(d => {
                    if (!d || d.success !== true) { throw new Error(d && d.message || '保存失败'); }
                    return d;
                });
            }

            function imageFormatter(cell){
                const data = cell.getRow().getData();
                const has = !!data.image_path;
                const imgHtml = has
                    ? `<img src="/uploads/thumb_${data.image_path}" class="thumb-fixed" onclick="openImageModalById(${data.id})">`
                    : `<button class="btn btn-sm btn-outline-primary" onclick="openImageModalById(${data.id})">添加图片</button>`;
                return `${imgHtml}`;
            }

            function openImageModalById(id){
                currentImageRowId = id;
                const data = getRowData(id);
                const imgEl = document.getElementById('imageModalPreview');
                const emptyEl = document.getElementById('imageModalEmpty');
                if (!imgEl || !emptyEl || !imageModal) return;
                if (data && data.image_path) {
                    imgEl.src = `/uploads/${data.image_path}`;
                    imgEl.classList.remove('d-none');
                    emptyEl.classList.add('d-none');
                    document.getElementById('btnModalAddOrChange').textContent = '更换图片';
                    document.getElementById('btnModalDelete').classList.remove('d-none');
                } else {
                    imgEl.src = '';
                    imgEl.classList.add('d-none');
                    emptyEl.classList.remove('d-none');
                    document.getElementById('btnModalAddOrChange').textContent = '添加图片';
                    document.getElementById('btnModalDelete').classList.add('d-none');
                }
                imageModal.show();
            }

            function getRowData(id){
                const row = todayGrid?.getRow(id);
                return row ? row.getData() : rowCache.get(id);
            }

            function getRow(id){
                return todayGrid?.getRow(id) || null;
            }

            function setRowImagePath(id, filename){
                const row = getRow(id);
                if (row) {
                    row.update({ image_path: filename || null });
                    if (typeof row.reformat === 'function') {
                        try { row.reformat(); } catch(e) {}
                    }
                }
                const d = rowCache.get(id) || {};
                d.image_path = filename || null;
                rowCache.set(id, d);
                if (currentImageRowId === id) {
                    // 同步弹框UI
                    openImageModalById(id);
                }
            }

            function triggerImagePick(id){
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = () => {
                    const file = input.files && input.files[0];
                    if (!file) return;
                    const fd = new FormData();
                    fd.append('id', String(id));
                    fd.append('image', file);
                    fetch('/product/update_image', { method: 'POST', body: fd })
                      .then(r => r.json())
                      .then(d => {
                          if (!d.success) return showMessage(d.message || '图片更新失败', 'error');
                          showMessage('图片更新成功', 'success');
                          setRowImagePath(id, d.filename || null);
                      })
                      .catch(err => showMessage('图片更新失败: ' + err.message, 'error'));
                };
                input.click();
            }

            function deleteImageFromModal(id){
                if (!confirm('确定删除该行图片？')) return;
                const fd = new FormData();
                fd.append('id', String(id));
                fd.append('delete_image', '1');
                fetch('/product/update_image', { method: 'POST', body: fd })
                  .then(r => r.json())
                  .then(d => {
                      if (!d.success) return showMessage(d.message || '删除失败', 'error');
                      showMessage('图片已删除', 'success');
                      setRowImagePath(id, null);
                  })
                  .catch(err => showMessage('删除失败: ' + err.message, 'error'));
            }

            // 计算 & 格式化
            function num(n){ const v = Number(n); return Number.isFinite(v) ? v : 0; }
            function calcUnitPriceDiscounted(d){ return num(d.unit_price) * (num(d.unit_discount_rate) || 100) / 100.0; }
            function calcAmount(d){ return calcUnitPriceDiscounted(d) * num(d.quantity); }
            function calcAmountDiscounted(d){ return calcAmount(d) * (num(d.order_discount_rate) || 100) / 100.0; }
            function calcReceivable(d){ return calcAmountDiscounted(d) + num(d.freight); }
            function calcBalance(d){ return calcReceivable(d) - num(d.paid_total); }
            function toFixed2(x){ return num(x).toFixed(2); }
            function decimal2(cell){ const v = cell.getValue(); return toFixed2(v); }

            function normalizeRow(p){
                return Object.assign({}, p, {
                    unit: (p.unit || p.spec || ''),
                    unit_price: Number(p.unit_price ?? p.price ?? 0),
                });
            }

            function refreshToday() {
                // 直接拉取第一页数据，前端过滤当天
                fetch('/product/list?page=1&per_page=200')
                    .then(r => r.json())
                    .then(d => {
                        if (!d.success) return showMessage(d.message, 'error');
                        const today = new Date().toISOString().slice(0, 10);
                        const rows = (d.data.products || [])
                          .filter(p => (p.create_time || '').slice(0,10) === today)
                          .map(normalizeRow)
                          .sort((a,b) => (b.create_time || '').localeCompare(a.create_time || ''));
                        rowCache = new Map(rows.map(p => [p.id, { ...p }]));
                        if (todayGrid) todayGrid.replaceData(rows);
                    })
                    .catch(err => showMessage('加载今日数据失败: ' + err.message, 'error'));
            }

            // ===== 下面保留原有表单/业务函数 =====

            function addProduct() {
                const formData = new FormData(document.getElementById('productForm'));
                fetch('/product/add', { method: 'POST', body: formData })
                    .then(r => r.json())
                    .then(d => {
                        if (d.success) {
                            showMessage(d.message, 'success');
                            refreshToday();
                        } else showMessage(d.message, 'error');
                    })
                    .catch(err => showMessage('添加失败: ' + err.message, 'error'));
            }

            function clearForm() {
                const form = document.getElementById('productForm');
                if (!form) return;
                form.reset();
                const imgInput = document.getElementById('image');
                if (imgInput) { imgInput.value = ''; }
                // 重新设置默认日期
                const dd = document.getElementById('doc_date');
                if (dd) {
                    const now = new Date();
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                    dd.value = now.toISOString().slice(0, 10);
                }
                recalc();
            }

            function markInvalid(el, invalid) {
                if (!el) return;
                if (invalid) {
                    el.classList.add('is-invalid');
                } else {
                    el.classList.remove('is-invalid');
                }
            }

            function validateForm() {
                let ok = true;
                const docDate = document.getElementById('doc_date');
                const name = document.getElementById('name');
                const productDesc = document.getElementById('product_desc');
                const quantity = document.getElementById('quantity');
                const price = document.getElementById('price');

                markInvalid(docDate, !docDate.value);
                ok = ok && !!docDate.value;

                markInvalid(name, !name.value.trim());
                ok = ok && !!name.value.trim();

                markInvalid(productDesc, !productDesc.value.trim());
                ok = ok && !!productDesc.value.trim();

                markInvalid(quantity, quantity.value === '' || Number.isNaN(Number(quantity.value)) || Number(quantity.value) < 0);
                ok = ok && !(quantity.value === '' || Number.isNaN(Number(quantity.value)) || Number(quantity.value) < 0);

                markInvalid(price, price.value === '' || Number.isNaN(Number(price.value)) || Number(price.value) < 0);
                ok = ok && !(price.value === '' || Number.isNaN(Number(price.value)) || Number(price.value) < 0);

                return ok;
            }

            function recalc() {
                const qty = Number(document.getElementById('quantity')?.value || 0);
                const unitPrice = Number(document.getElementById('price')?.value || 0);
                const unitRate = Number(document.getElementById('unit_discount_rate')?.value || 100);
                const orderRate = Number(document.getElementById('order_discount_rate')?.value || 100);
                const freight = Number(document.getElementById('freight')?.value || 0);
                const paidTotal = Number(document.getElementById('paid_total')?.value || 0);

                const unitPriceDiscounted = unitPrice * unitRate / 100.0;
                const amount = unitPriceDiscounted * qty;
                const amountDiscounted = amount * orderRate / 100.0;
                const receivable = amountDiscounted + freight;
                const balance = receivable - paidTotal;

                const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
                set('unit_price_discounted', unitPriceDiscounted.toFixed(2));
                set('amount', amount.toFixed(2));
                set('amount_discounted', amountDiscounted.toFixed(2));
                set('receivable', receivable.toFixed(2));
                set('balance', balance.toFixed(2));
            }

            function editProduct(id, name, price, quantity, spec, imagePath) {
                document.getElementById('editProductId').value = id;
                document.getElementById('editName').value = name;
                document.getElementById('editPrice').value = price;
                document.getElementById('editQuantity').value = quantity;
                document.getElementById('editSpec').value = spec || '';
                const current = document.getElementById('currentImageDisplay');
                current.innerHTML = imagePath ? `<img src="/uploads/thumb_${imagePath}" class="product-image" onclick="viewImage('/uploads/${imagePath}')">` : '<span class="text-muted">无图片</span>';
                new bootstrap.Modal(document.getElementById('editProductModal')).show();
            }

            function deleteProduct(id, name) {
                if (!confirm(`确定删除商品"${name}"？`)) return;
                fetch('/product/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                })
                    .then(r => r.json())
                    .then(d => {
                        if (d.success) { showMessage(d.message, 'success'); refreshToday(); }
                        else showMessage(d.message, 'error');
                    })
                    .catch(err => showMessage('删除失败: ' + err.message, 'error'));
            }

            function updateProduct() {
                const formData = new FormData(document.getElementById('editProductForm'));
                fetch('/product/update', { method: 'POST', body: formData })
                    .then(r => r.json())
                    .then(d => {
                        if (d.success) {
                            showMessage(d.message, 'success');
                            bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
                            refreshToday();
                        } else showMessage(d.message, 'error');
                    })
                    .catch(err => showMessage('更新失败: ' + err.message, 'error'));
            }

            function viewImage(imageUrl) {
                const img = document.getElementById('fullSizeImage');
                const link = document.getElementById('downloadImageLink');
                img.src = '';
                img.alt = '加载中...';
                img.style.opacity = '0.5';
                img.src = imageUrl;
                link.href = imageUrl;
                img.onload = function () { img.style.opacity = '1'; img.alt = '商品原图'; };
                img.onerror = function () { img.alt = '图片加载失败'; img.style.opacity = '0.3'; showMessage('图片加载失败', 'error'); };
                new bootstrap.Modal(document.getElementById('imageViewModal')).show();
            }

            function showMessage(message, type = 'info') {
                const toast = document.getElementById('messageToast');
                const toastMessage = document.getElementById('toastMessage');
                toastMessage.textContent = message;
                toast.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');
                switch (type) {
                    case 'success': toast.classList.add('bg-success', 'text-white'); break;
                    case 'error': toast.classList.add('bg-danger', 'text-white'); break;
                    case 'warning': toast.classList.add('bg-warning'); break;
                    default: toast.classList.add('bg-info', 'text-white');
                }
                new bootstrap.Toast(toast).show();
            }

            function logout() {
                fetch('/auth/logout', { method: 'POST' })
                    .then(r => r.json())
                    .then(() => { window.location.href = '/auth/login'; })
                    .catch(() => { window.location.href = '/auth/login'; });
            }
        </script>
    </body>
</html>