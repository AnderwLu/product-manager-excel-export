<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>录入 - 商品信息管理</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet" />
        <style>
            .product-image { max-width: 70px; max-height: 70px; object-fit: cover; cursor: pointer; }
            /* 顶部导航：居中+高亮 */
            .navbar .navbar-nav { gap: 1.25rem; }
            .navbar .nav-link { color: rgba(255,255,255,.7); font-weight: 600; }
            .navbar .nav-link.active {
                color: #fff !important;
                background-color: #0d6efd;
                border-radius: .5rem;
                padding: .25rem .85rem;
                box-shadow: 0 0 .6rem rgba(13,110,253,.55);
            }
            .navbar .nav-link:hover { color: #fff; }
        </style>
    </head>
    <body class="bg-light">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">商品管理</a>
                <div class="navbar-nav mx-auto flex-row">
                    <a class="nav-link" href="/search">查询/导出</a>
                    <a class="nav-link active" aria-current="page" href="/entry">录入</a>
                </div>
            </div>
        </nav>

        <div class="container py-4">
            <div class="row g-3">
                <div class="col-12">
                    <div class="bg-white rounded shadow-sm p-3">
                        <h4 class="mb-3"><i class="bi bi-plus-circle"></i> 添加商品</h4>
                        <form id="productForm" enctype="multipart/form-data">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">商品名称 *</label>
                                    <input class="form-control" id="name" name="name" required />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">价格 *</label>
                                    <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" required />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">数量 *</label>
                                    <input type="number" class="form-control" id="quantity" name="quantity" min="0" required />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">规格</label>
                                    <input class="form-control" id="spec" name="spec" />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">图片</label>
                                    <input type="file" class="form-control" id="image" name="image" accept="image/*" />
                                </div>
                            </div>
                            <div class="mt-3">
                                <button type="submit" class="btn btn-primary"><i class="bi bi-plus"></i> 添加</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('productForm').reset()"><i class="bi bi-eraser"></i> 清空</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="col-12">
                    <div class="bg-white rounded shadow-sm p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0"><i class="bi bi-list"></i> 今日录入（倒序）</h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="refreshToday()"><i class="bi bi-arrow-clockwise"></i> 刷新</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>图片</th>
                                        <th>名称</th>
                                        <th>价格</th>
                                        <th>数量</th>
                                        <th>规格</th>
                                        <th>创建时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="todayTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 编辑模态框复用 -->
        <div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-pencil"></i> 修改商品</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form id="editProductForm" enctype="multipart/form-data">
                        <div class="modal-body">
                            <input type="hidden" id="editProductId" name="id" />
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">名称 *</label>
                                    <input class="form-control" id="editName" name="name" required />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">价格 *</label>
                                    <input type="number" step="0.01" min="0" class="form-control" id="editPrice" name="price" required />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">数量 *</label>
                                    <input type="number" min="0" class="form-control" id="editQuantity" name="quantity" required />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">规格</label>
                                    <input class="form-control" id="editSpec" name="spec" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">新图片</label>
                                    <input type="file" class="form-control" id="editImage" name="image" accept="image/*" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">当前图片</label>
                                    <div id="currentImageDisplay" class="border rounded p-2 text-center"><span class="text-muted">无图片</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-check"></i> 保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 查看图片模态框 -->
        <div class="modal fade" id="imageViewModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-image"></i> 商品图片</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img id="fullSizeImage" src="" alt="商品原图" class="img-fluid" style="max-height: 80vh" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        <a id="downloadImageLink" href="" download class="btn btn-primary"><i class="bi bi-download"></i> 下载图片</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="messageToast" class="toast" role="alert">
                <div class="toast-header">
                    <strong class="me-auto">系统消息</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                document.getElementById('productForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    addProduct();
                });
                document.getElementById('editProductForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    updateProduct();
                });
                refreshToday();
            });

            function addProduct() {
                const formData = new FormData(document.getElementById('productForm'));
                fetch('/product/add', { method: 'POST', body: formData })
                    .then(r => r.json())
                    .then(d => {
                        if (d.success) {
                            showMessage(d.message, 'success');
                            document.getElementById('productForm').reset();
                            refreshToday();
                        } else showMessage(d.message, 'error');
                    })
                    .catch(err => showMessage('添加失败: ' + err.message, 'error'));
            }

            function refreshToday() {
                // 直接拉取第一页数据，前端过滤当天
                fetch('/product/list?page=1&per_page=200')
                    .then(r => r.json())
                    .then(d => {
                        if (!d.success) return showMessage(d.message, 'error');
                        const today = new Date().toISOString().slice(0, 10);
                        const rows = (d.data.products || []).filter(p => (p.create_time || '').slice(0,10) === today);
                        rows.sort((a,b) => (b.create_time || '').localeCompare(a.create_time || ''));
                        renderToday(rows);
                    })
                    .catch(err => showMessage('加载今日数据失败: ' + err.message, 'error'));
            }

            function renderToday(products) {
                const tbody = document.getElementById('todayTableBody');
                tbody.innerHTML = '';
                if (!products || products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">今日暂无录入</td></tr>';
                    return;
                }
                products.forEach(product => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${product.id}</td>
                        <td>${product.image_path ? `<img src="/uploads/thumb_${product.image_path}" class="product-image" onclick="viewImage('/uploads/${product.image_path}')">` : '<span class="text-muted">无</span>'}</td>
                        <td>${product.name}</td>
                        <td>¥${parseFloat(product.price).toFixed(2)}</td>
                        <td>${product.quantity}</td>
                        <td>${product.spec || '-'}</td>
                        <td>${product.create_time || '-'}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editProduct(${product.id}, '${product.name}', ${product.price}, ${product.quantity}, '${product.spec || ''}', '${product.image_path || ''}')"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-outline-danger" onclick="deleteProduct(${product.id}, '${product.name}')"><i class="bi bi-trash"></i></button>
                            </div>
                        </td>`;
                    tbody.appendChild(tr);
                });
            }

            function editProduct(id, name, price, quantity, spec, imagePath) {
                document.getElementById('editProductId').value = id;
                document.getElementById('editName').value = name;
                document.getElementById('editPrice').value = price;
                document.getElementById('editQuantity').value = quantity;
                document.getElementById('editSpec').value = spec || '';
                const current = document.getElementById('currentImageDisplay');
                current.innerHTML = imagePath ? `<img src="/uploads/thumb_${imagePath}" class="product-image" onclick="viewImage('/uploads/${imagePath}')">` : '<span class="text-muted">无图片</span>';
                new bootstrap.Modal(document.getElementById('editProductModal')).show();
            }

            function deleteProduct(id, name) {
                if (!confirm(`确定删除商品"${name}"？`)) return;
                fetch('/product/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                })
                    .then(r => r.json())
                    .then(d => {
                        if (d.success) { showMessage(d.message, 'success'); refreshToday(); }
                        else showMessage(d.message, 'error');
                    })
                    .catch(err => showMessage('删除失败: ' + err.message, 'error'));
            }

            function updateProduct() {
                const formData = new FormData(document.getElementById('editProductForm'));
                fetch('/product/update', { method: 'POST', body: formData })
                    .then(r => r.json())
                    .then(d => {
                        if (d.success) {
                            showMessage(d.message, 'success');
                            bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
                            refreshToday();
                        } else showMessage(d.message, 'error');
                    })
                    .catch(err => showMessage('更新失败: ' + err.message, 'error'));
            }

            function viewImage(imageUrl) {
                const img = document.getElementById('fullSizeImage');
                const link = document.getElementById('downloadImageLink');
                img.src = '';
                img.alt = '加载中...';
                img.style.opacity = '0.5';
                img.src = imageUrl;
                link.href = imageUrl;
                img.onload = function () { img.style.opacity = '1'; img.alt = '商品原图'; };
                img.onerror = function () { img.alt = '图片加载失败'; img.style.opacity = '0.3'; showMessage('图片加载失败', 'error'); };
                new bootstrap.Modal(document.getElementById('imageViewModal')).show();
            }

            function showMessage(message, type = 'info') {
                const toast = document.getElementById('messageToast');
                const toastMessage = document.getElementById('toastMessage');
                toastMessage.textContent = message;
                toast.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');
                switch (type) {
                    case 'success': toast.classList.add('bg-success', 'text-white'); break;
                    case 'error': toast.classList.add('bg-danger', 'text-white'); break;
                    case 'warning': toast.classList.add('bg-warning'); break;
                    default: toast.classList.add('bg-info', 'text-white');
                }
                new bootstrap.Toast(toast).show();
            }
        </script>
    </body>
</html>

