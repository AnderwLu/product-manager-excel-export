<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>录入 - 商品信息管理</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet" />
        <style>
            body { padding-top: 64px; }
            .product-image { max-width: 70px; max-height: 70px; object-fit: cover; cursor: pointer; }
            /* 顶部导航：居中+高亮 */
            .navbar .navbar-nav { gap: 1.25rem; }
            .navbar .nav-link { color: rgba(255,255,255,.7); font-weight: 600; }
            .navbar .nav-link.active {
                color: #fff !important;
                background-color: #0d6efd;
                border-radius: .5rem;
                padding: .25rem .85rem;
                box-shadow: 0 0 .6rem rgba(13,110,253,.55);
            }
            .navbar .nav-link:hover { color: #fff; }
            /* 列表不换行，靠外层 .table-responsive 横向滚动 */
            .table-nowrap th, .table-nowrap td { white-space: nowrap; }
        </style>
    </head>
    <body class="bg-light">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">商品管理</a>
                <div class="navbar-nav mx-auto flex-row">
                    <a class="nav-link" href="/search">查询/导出</a>
                    <a class="nav-link active" aria-current="page" href="/entry">录入</a>
                    <a class="nav-link" href="/auth/users">用户管理</a>
                </div>
                <div class="d-flex align-items-center">
                    <span class="text-white-50 me-3">{{ (session.get('real_name') or session.get('username')) or '' }}</span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">退出</button>
                </div>
            </div>
        </nav>

        <div class="container py-4">
            <div class="row g-3">
                <div class="col-12">
                    <div class="bg-white rounded shadow-sm p-3">
                        <form id="productForm" enctype="multipart/form-data">
                            <div class="row g-3">
                                <!-- 第1行：单据日期、客户名称、品名规格、单位 -->
                                <div class="col-md-3">
                                    <label class="form-label">单据日期</label>
                                    <input type="date" class="form-control" id="doc_date" name="doc_date" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">客户名称 *</label>
                                    <input class="form-control" id="name" name="name" required />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">品名规格</label>
                                    <input class="form-control" id="product_desc" name="product_desc" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">单位</label>
                                    <input class="form-control" id="spec" name="spec" />
                                </div>

                                <!-- 第2行：单价、数量、单价折扣率、折后单价 -->
                                <div class="col-md-3">
                                    <label class="form-label">单价 *</label>
                                    <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" required />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">数量 *</label>
                                    <input type="number" class="form-control" id="quantity" name="quantity" min="0" required />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">单价折扣率(%)</label>
                                    <input type="number" class="form-control" id="unit_discount_rate" name="unit_discount_rate" step="0.01" value="100" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">折后单价</label>
                                    <input type="number" class="form-control" id="unit_price_discounted" name="unit_price_discounted" step="0.01" readonly />
                                </div>

                                <!-- 第3行：运费、整单折扣率、折后金额、应收款 -->
                                <div class="col-md-3">
                                    <label class="form-label">运费</label>
                                    <input type="number" class="form-control" id="freight" name="freight" step="0.01" value="0" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">整单折扣率(%)</label>
                                    <input type="number" class="form-control" id="order_discount_rate" name="order_discount_rate" step="0.01" value="100" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">折后金额</label>
                                    <input type="number" class="form-control" id="amount_discounted" name="amount_discounted" step="0.01" readonly />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">应收款</label>
                                    <input type="number" class="form-control" id="receivable" name="receivable" step="0.01" readonly />
                                </div>

                                <!-- 第4行：结算账户、本次收款、已收款、尾款 -->
                                <div class="col-md-3">
                                    <label class="form-label">结算账户</label>
                                    <input class="form-control" id="settlement_account" name="settlement_account" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">本次收款</label>
                                    <input type="number" class="form-control" id="payment_current" name="payment_current" step="0.01" value="0" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">已收款</label>
                                    <input type="number" class="form-control" id="paid_total" name="paid_total" step="0.01" value="0" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">尾款</label>
                                    <input type="number" class="form-control" id="balance" name="balance" step="0.01" readonly />
                                </div>

                                <!-- 第5行：备注、说明、图片、营业员 -->
                                <div class="col-md-3">
                                    <label class="form-label">备注</label>
                                    <input class="form-control" id="remark" name="remark" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">说明</label>
                                    <input class="form-control" id="description" name="description" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">图片</label>
                                    <input type="file" class="form-control" id="image" name="image" accept="image/*" />
                                </div>
                            </div>
                            <div class="mt-3">
                                <button type="submit" class="btn btn-primary"><i class="bi bi-plus"></i> 添加</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('productForm').reset()"><i class="bi bi-eraser"></i> 清空</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="col-12">
                    <div class="bg-white rounded shadow-sm p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0"><i class="bi bi-list"></i> 今日录入（倒序）</h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="refreshToday()"><i class="bi bi-arrow-clockwise"></i> 刷新</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped align-middle table-nowrap">
                                <thead class="table-dark">
                                    <tr>
                                        <th>单据日期</th><th>客户名称</th><th>品名规格</th><th>单位</th>
                                        <th>数量</th><th>单价</th><th>单价折扣率(%)</th><th>折后单价</th>
                                        <th>金额</th><th>图片</th><th>备注</th><th>运费</th>
                                        <th>整单折扣率(%)</th><th>折后金额</th><th>应收款</th>
                                        <th>本次收款</th><th>已收款</th><th>尾款</th><th>结算账户</th>
                                        <th>说明</th><th>营业员</th><th>修改时间</th><th>创建时间</th><th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="todayTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 编辑模态框复用 -->
        <div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-pencil"></i> 修改商品</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form id="editProductForm" enctype="multipart/form-data">
                        <div class="modal-body">
                            <input type="hidden" id="editProductId" name="id" />
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">名称 *</label>
                                    <input class="form-control" id="editName" name="name" required />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">价格 *</label>
                                    <input type="number" step="0.01" min="0" class="form-control" id="editPrice" name="price" required />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">数量 *</label>
                                    <input type="number" min="0" class="form-control" id="editQuantity" name="quantity" required />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">规格</label>
                                    <input class="form-control" id="editSpec" name="spec" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">新图片</label>
                                    <input type="file" class="form-control" id="editImage" name="image" accept="image/*" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">当前图片</label>
                                    <div id="currentImageDisplay" class="border rounded p-2 text-center"><span class="text-muted">无图片</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-check"></i> 保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 查看图片模态框 -->
        <div class="modal fade" id="imageViewModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-image"></i> 商品图片</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img id="fullSizeImage" src="" alt="商品原图" class="img-fluid" style="max-height: 80vh" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        <a id="downloadImageLink" href="" download class="btn btn-primary"><i class="bi bi-download"></i> 下载图片</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="messageToast" class="toast" role="alert">
                <div class="toast-header">
                    <strong class="me-auto">系统消息</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                document.getElementById('productForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    addProduct();
                });
                document.getElementById('editProductForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    updateProduct();
                });
                // 默认日期
                const dd = document.getElementById('doc_date');
                if (dd) dd.value = new Date().toISOString().slice(0,10);
                // 绑定计算
                ['quantity','price','unit_discount_rate','order_discount_rate','freight','payment_current','paid_total']
                    .forEach(id => document.getElementById(id)?.addEventListener('input', recalc));
                recalc();
                refreshToday();
            });

            function addProduct() {
                const formData = new FormData(document.getElementById('productForm'));
                fetch('/product/add', { method: 'POST', body: formData })
                    .then(r => r.json())
                    .then(d => {
                        if (d.success) {
                            showMessage(d.message, 'success');
                            // 重置输入框，包括文件选择
                            const form = document.getElementById('productForm');
                            form.reset();
                            // 兼容性处理：清空file input的值
                            const imgInput = document.getElementById('image');
                            if (imgInput) { imgInput.value = ''; }
                            refreshToday();
                        } else showMessage(d.message, 'error');
                    })
                    .catch(err => showMessage('添加失败: ' + err.message, 'error'));
            }

            function refreshToday() {
                // 直接拉取第一页数据，前端过滤当天
                fetch('/product/list?page=1&per_page=200')
                    .then(r => r.json())
                    .then(d => {
                        if (!d.success) return showMessage(d.message, 'error');
                        const today = new Date().toISOString().slice(0, 10);
                        const rows = (d.data.products || []).filter(p => (p.create_time || '').slice(0,10) === today);
                        rows.sort((a,b) => (b.create_time || '').localeCompare(a.create_time || ''));
                        renderToday(rows);
                    })
                    .catch(err => showMessage('加载今日数据失败: ' + err.message, 'error'));
            }

            function renderToday(products) {
                const tbody = document.getElementById('todayTableBody');
                tbody.innerHTML = '';
                if (!products || products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="25" class="text-center">今日暂无录入</td></tr>';
                    return;
                }
                products.forEach(p => {
                    const docDate = p.doc_date || (p.create_time || '').slice(0,10);
                    const unitPrice = Number(p.unit_price ?? p.price ?? 0);
                    const qty = Number(p.quantity ?? 0);
                    const unitRate = Number(p.unit_discount_rate ?? 100);
                    const priceDiscounted = unitPrice * unitRate / 100.0;
                    const amount = (p.amount != null) ? Number(p.amount) : priceDiscounted * qty;
                    const orderRate = Number(p.order_discount_rate ?? 100);
                    const amountDiscounted = (p.amount_discounted != null) ? Number(p.amount_discounted) : amount * orderRate / 100.0;
                    const freight = Number(p.freight ?? 0);
                    const receivable = (p.receivable != null) ? Number(p.receivable) : (amountDiscounted + freight);
                    const paidTotal = Number(p.paid_total ?? 0);
                    const balance = (p.balance != null) ? Number(p.balance) : (receivable - paidTotal);

                    const productDesc = p.product_desc || `${p.name || ''}${p.spec ? ' ' + p.spec : ''}`.trim();
                    const unit = p.unit || p.spec || '';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                      <td>${docDate || '-'}</td>
                      <td>${p.customer_name || p.name || '-'}</td>
                      <td>${productDesc || '-'}</td>
                      <td>${unit || '-'}</td>
                      <td>${qty || 0}</td>
                      <td>${unitPrice.toFixed(2)}</td>
                      <td>${unitRate.toFixed(2)}</td>
                      <td>${priceDiscounted.toFixed(2)}</td>
                      <td>${amount.toFixed(2)}</td>
                      <td>${p.image_path ? `<img src="/uploads/thumb_${p.image_path}" class="product-image" onclick="viewImage('/uploads/${p.image_path}')">` : '<span class="text-muted">无</span>'}</td>
                      <td>${p.remark || ''}</td>
                      <td>${freight.toFixed(2)}</td>
                      <td>${orderRate.toFixed(2)}</td>
                      <td>${amountDiscounted.toFixed(2)}</td>
                      <td>${receivable.toFixed(2)}</td>
                      <td>${Number(p.payment_current ?? 0).toFixed(2)}</td>
                      <td>${paidTotal.toFixed(2)}</td>
                      <td>${balance.toFixed(2)}</td>
                      <td>${p.settlement_account || ''}</td>
                      <td>${p.description || ''}</td>
                      <td>${p.salesperson || ''}</td>
                      <td>${p.update_time || ''}</td>
                      <td>${p.create_time || ''}</td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <button class="btn btn-outline-primary" onclick="editProduct(${p.id}, '${p.name}', ${p.price}, ${p.quantity}, '${p.spec || ''}', '${p.image_path || ''}')"><i class="bi bi-pencil"></i></button>
                          <button class="btn btn-outline-danger" onclick="deleteProduct(${p.id}, '${p.name}')"><i class="bi bi-trash"></i></button>
                        </div>
                      </td>`;
                    tbody.appendChild(tr);
                });
            }

            function recalc() {
                const qty = Number(document.getElementById('quantity')?.value || 0);
                const unitPrice = Number(document.getElementById('price')?.value || 0);
                const unitRate = Number(document.getElementById('unit_discount_rate')?.value || 100);
                const orderRate = Number(document.getElementById('order_discount_rate')?.value || 100);
                const freight = Number(document.getElementById('freight')?.value || 0);
                const paidTotal = Number(document.getElementById('paid_total')?.value || 0);

                const unitPriceDiscounted = unitPrice * unitRate / 100.0;
                const amount = unitPriceDiscounted * qty;
                const amountDiscounted = amount * orderRate / 100.0;
                const receivable = amountDiscounted + freight;
                const balance = receivable - paidTotal;

                const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
                set('unit_price_discounted', unitPriceDiscounted.toFixed(2));
                set('amount', amount.toFixed(2));
                set('amount_discounted', amountDiscounted.toFixed(2));
                set('receivable', receivable.toFixed(2));
                set('balance', balance.toFixed(2));
            }

            function editProduct(id, name, price, quantity, spec, imagePath) {
                document.getElementById('editProductId').value = id;
                document.getElementById('editName').value = name;
                document.getElementById('editPrice').value = price;
                document.getElementById('editQuantity').value = quantity;
                document.getElementById('editSpec').value = spec || '';
                const current = document.getElementById('currentImageDisplay');
                current.innerHTML = imagePath ? `<img src="/uploads/thumb_${imagePath}" class="product-image" onclick="viewImage('/uploads/${imagePath}')">` : '<span class="text-muted">无图片</span>';
                new bootstrap.Modal(document.getElementById('editProductModal')).show();
            }

            function deleteProduct(id, name) {
                if (!confirm(`确定删除商品"${name}"？`)) return;
                fetch('/product/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                })
                    .then(r => r.json())
                    .then(d => {
                        if (d.success) { showMessage(d.message, 'success'); refreshToday(); }
                        else showMessage(d.message, 'error');
                    })
                    .catch(err => showMessage('删除失败: ' + err.message, 'error'));
            }

            function updateProduct() {
                const formData = new FormData(document.getElementById('editProductForm'));
                fetch('/product/update', { method: 'POST', body: formData })
                    .then(r => r.json())
                    .then(d => {
                        if (d.success) {
                            showMessage(d.message, 'success');
                            bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
                            refreshToday();
                        } else showMessage(d.message, 'error');
                    })
                    .catch(err => showMessage('更新失败: ' + err.message, 'error'));
            }

            function viewImage(imageUrl) {
                const img = document.getElementById('fullSizeImage');
                const link = document.getElementById('downloadImageLink');
                img.src = '';
                img.alt = '加载中...';
                img.style.opacity = '0.5';
                img.src = imageUrl;
                link.href = imageUrl;
                img.onload = function () { img.style.opacity = '1'; img.alt = '商品原图'; };
                img.onerror = function () { img.alt = '图片加载失败'; img.style.opacity = '0.3'; showMessage('图片加载失败', 'error'); };
                new bootstrap.Modal(document.getElementById('imageViewModal')).show();
            }

            function showMessage(message, type = 'info') {
                const toast = document.getElementById('messageToast');
                const toastMessage = document.getElementById('toastMessage');
                toastMessage.textContent = message;
                toast.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');
                switch (type) {
                    case 'success': toast.classList.add('bg-success', 'text-white'); break;
                    case 'error': toast.classList.add('bg-danger', 'text-white'); break;
                    case 'warning': toast.classList.add('bg-warning'); break;
                    default: toast.classList.add('bg-info', 'text-white');
                }
                new bootstrap.Toast(toast).show();
            }

            function logout() {
                fetch('/auth/logout', { method: 'POST' })
                    .then(r => r.json())
                    .then(() => { window.location.href = '/auth/login'; })
                    .catch(() => { window.location.href = '/auth/login'; });
            }
        </script>
    </body>
</html>

