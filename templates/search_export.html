<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>查询与导出 - 商品信息管理</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet" />
        <style>
            body { padding-top: 64px; }
            .product-image { max-width: 80px; max-height: 80px; object-fit: cover; cursor: pointer; }
            .nav-tabs .nav-link.active { font-weight: 600; }
            /* 顶部导航：居中+高亮 */
            .navbar .navbar-nav { gap: 1.25rem; }
            .navbar .nav-link { color: rgba(255,255,255,.7); font-weight: 600; }
            .navbar .nav-link.active {
                color: #fff !important;
                background-color: #0d6efd;
                border-radius: .5rem;
                padding: .25rem .85rem;
                box-shadow: 0 0 .6rem rgba(13,110,253,.55);
            }
            .navbar .nav-link:hover { color: #fff; }
            /* 导出列拖拽样式 */
            #columnList { margin: 0; padding: 0; }
            #columnList .draggable-item { display: flex; align-items: center; gap: .5rem; padding: .5rem .75rem; border: 1px solid #e9ecef; border-radius: .5rem; margin-bottom: .5rem; background: #f8f9fa; }
            #columnList .draggable-item .drag-handle { cursor: grab; color: #6c757d; }
            #columnList .draggable-item.dragging { opacity: .6; }
            /* 导出卡片布局：固定头部，列表独立滚动 */
            #exportCard { display: flex; flex-direction: column; max-height: 72vh; }
            #exportToolbar { display: flex; align-items: center; gap: .5rem; }
            #columnListContainer { flex: 1 1 auto; overflow: auto; padding-top: .25rem; }
            .center-hint { text-align: center; color: #6c757d; }
            /* 列表不换行，靠外层 .table-responsive 横向滚动 */
            .table-nowrap th, .table-nowrap td { white-space: nowrap; }
        </style>
    </head>
    <body class="bg-light">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">商品管理</a>
                <div class="navbar-nav mx-auto flex-row">
                    <a class="nav-link active" aria-current="page" href="/search">查询/导出</a>
                    <a class="nav-link" href="/search-edit">查询/编辑</a>
                    <a class="nav-link" href="/entry">录入</a>
                    <a class="nav-link" href="/auth/users">用户管理</a>
                </div>
                <div class="d-flex align-items-center">
                    <span class="text-white-50 me-3">{{ (session.get('real_name') or session.get('username')) or '' }}</span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">退出</button>
                </div>
            </div>
        </nav>

        <div class="container py-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0"><i class="bi bi-search"></i> 查询与导出</h3>
            </div>

            <ul class="nav nav-tabs mb-3" id="modeTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-pane" type="button" role="tab">查询</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="export-tab" data-bs-toggle="tab" data-bs-target="#export-pane" type="button" role="tab">导出</button>
                </li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="search-pane" role="tabpanel">
                    <div class="row g-3 align-items-end mb-3">
                        <div class="col-md-3">
                            <label class="form-label">客户名称(模糊)</label>
                            <input class="form-control" id="searchInput" placeholder="客户名称" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">品名规格(模糊)</label>
                            <input class="form-control" id="searchProductDesc" placeholder="品名规格" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">营业员(模糊)</label>
                            <input class="form-control" id="searchSalesperson" placeholder="营业员" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">单据日期(起止)</label>
                            <div class="d-flex gap-1">
                                <input type="date" class="form-control" id="dateStart" />
                                <span class="align-self-center">~</span>
                                <input type="date" class="form-control" id="dateEnd" />
                            </div>
                        </div>
                        <div class="col-md-12">
                            <button class="btn btn-primary me-2" onclick="searchProducts()"><i class="bi bi-search"></i> 查询</button>
                            <button class="btn btn-success me-2" onclick="exportWithFilters()"><i class="bi bi-file-earmark-excel"></i> 导出</button>
                            <button class="btn btn-outline-secondary me-2" onclick="resetSearch()"><i class="bi bi-x-lg"></i> 重置</button>
                        </div>
                    </div>

                    <div class="table-responsive bg-white rounded shadow-sm p-3">
                        <table class="table table-striped align-middle table-nowrap">
                            <thead class="table-dark">
                                <tr>
                                    <th>单据日期</th><th>客户名称</th><th>品名规格</th><th>单位</th>
                                    <th>数量</th><th>单价</th><th>单价折扣率(%)</th><th>折后单价</th>
                                    <th>金额</th><th>图片</th><th>备注</th><th>运费</th>
                                    <th>整单折扣率(%)</th><th>折后金额</th><th>应收款</th>
                                    <th>已收款</th><th>尾款</th><th>结算账户</th>
                                    <th>说明</th><th>营业员</th><th>修改时间</th><th>创建时间</th><th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="productTableBody"></tbody>
                        </table>
                        <nav aria-label="分页"><ul class="pagination justify-content-center" id="pagination"></ul></nav>
                    </div>
                </div>

                <div class="tab-pane fade" id="export-pane" role="tabpanel">
                    <div class="bg-white rounded shadow-sm p-3" id="exportCard">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0"><i class="bi bi-download"></i> 导出Excel</h5>
                            <div id="exportToolbar">
                                <button class="btn btn-outline-secondary btn-sm" onclick="toggleAllColumns(true)">全选</button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="toggleAllColumns(false)">全不选</button>
                                <button class="btn btn-success btn-sm" onclick="saveColumnsToServer()"><i class="bi bi-save"></i> 保存</button>
                            </div>
                        </div>

                        <div class="center-hint mb-2"><small>勾选导出列，拖拽调顺序</small></div>

                        <div id="columnListContainer">
                        <ul id="columnList" class="list-unstyled">
                            <li class="draggable-item" draggable="true" data-key="doc_date">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_doc_date" value="doc_date" checked>
                                <label class="form-check-label ms-2" for="col_doc_date">单据日期</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="name">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_name" value="name" checked>
                                <label class="form-check-label ms-2" for="col_name">品名规格</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="unit">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_unit" value="unit" checked>
                                <label class="form-check-label ms-2" for="col_unit">单位</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="quantity">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_quantity" value="quantity" checked>
                                <label class="form-check-label ms-2" for="col_quantity">数量</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="unit_price">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_unit_price" value="unit_price" checked>
                                <label class="form-check-label ms-2" for="col_unit_price">单价</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="amount">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_amount" value="amount" checked>
                                <label class="form-check-label ms-2" for="col_amount">金额</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="remark">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_remark" value="remark" checked>
                                <label class="form-check-label ms-2" for="col_remark">备注</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="image">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_image" value="image" checked>
                                <label class="form-check-label ms-2" for="col_image">图片</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="description">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_description" value="description" checked>
                                <label class="form-check-label ms-2" for="col_description">说明</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="salesperson">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_salesperson" value="salesperson" checked>
                                <label class="form-check-label ms-2" for="col_salesperson">营业员</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="unit_discount_rate">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_udr" value="unit_discount_rate">
                                <label class="form-check-label ms-2" for="col_udr">单价折扣率(%)</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="unit_price_discounted">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_upd" value="unit_price_discounted">
                                <label class="form-check-label ms-2" for="col_upd">折后单价</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="freight">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_freight" value="freight">
                                <label class="form-check-label ms-2" for="col_freight">运费</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="order_discount_rate">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_odr" value="order_discount_rate">
                                <label class="form-check-label ms-2" for="col_odr">整单折扣率(%)</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="amount_discounted">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_amount_discounted" value="amount_discounted">
                                <label class="form-check-label ms-2" for="col_amount_discounted">折后金额</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="receivable">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_receivable" value="receivable">
                                <label class="form-check-label ms-2" for="col_receivable">应收款</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="paid_total">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_paid_total" value="paid_total">
                                <label class="form-check-label ms-2" for="col_paid_total">已收款</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="balance">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_balance" value="balance">
                                <label class="form-check-label ms-2" for="col_balance">尾款</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="settlement_account">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_settlement_account" value="settlement_account">
                                <label class="form-check-label ms-2" for="col_settlement_account">结算账户</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="update_time">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_update_time" value="update_time">
                                <label class="form-check-label ms-2" for="col_update_time">修改时间</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="create_time">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_create_time" value="create_time">
                                <label class="form-check-label ms-2" for="col_create_time">创建时间</label>
                            </li>
                            <li class="draggable-item" draggable="true" data-key="customer_name">
                                <span class="drag-handle bi bi-grip-vertical"></span>
                                <input class="form-check-input col-check" type="checkbox" id="col_customer" value="customer_name">
                                <label class="form-check-label ms-2" for="col_customer">客户名称</label>
                            </li>
                        </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 编辑模态框复用 -->
        <div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-pencil"></i> 修改商品</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form id="editProductForm" enctype="multipart/form-data">
                        <div class="modal-body">
                            <input type="hidden" id="editProductId" name="id" />
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">单据日期</label>
                                    <input type="date" class="form-control" id="editDocDate" name="doc_date" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">客户名称 *</label>
                                    <input class="form-control" id="editName" name="name" required />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">品名规格 *</label>
                                    <input class="form-control" id="editProductDesc" name="product_desc" required />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">单位</label>
                                    <input class="form-control" id="editSpec" name="spec" />
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label">单价 *</label>
                                    <input type="number" step="0.01" min="0" class="form-control" id="editPrice" name="price" required />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">数量 *</label>
                                    <input type="number" min="0" class="form-control" id="editQuantity" name="quantity" required />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">运费</label>
                                    <input type="number" step="0.01" class="form-control" id="editFreight" name="freight" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">已收款</label>
                                    <input type="number" step="0.01" class="form-control" id="editPaidTotal" name="paid_total" />
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label">备注</label>
                                    <input class="form-control" id="editRemark" name="remark" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">结算账户</label>
                                    <input class="form-control" id="editSettlement" name="settlement_account" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">说明</label>
                                    <input class="form-control" id="editDescription" name="description" />
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label">新图片</label>
                                    <input type="file" class="form-control" id="editImage" name="image" accept="image/*" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">当前图片</label>
                                    <div id="currentImageDisplay" class="border rounded p-2 text-center"><span class="text-muted">无图片</span></div>
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" id="editDeleteImage" name="delete_image" value="1" />
                                        <label class="form-check-label" for="editDeleteImage">删除当前图片</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-check"></i> 保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 查看图片模态框 -->
        <div class="modal fade" id="imageViewModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-image"></i> 商品图片</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img id="fullSizeImage" src="" alt="商品原图" class="img-fluid" style="max-height: 80vh" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        <a id="downloadImageLink" href="" download class="btn btn-primary"><i class="bi bi-download"></i> 下载图片</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="messageToast" class="toast" role="alert">
                <div class="toast-header">
                    <strong class="me-auto">系统消息</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            let currentPage = 1;
            let totalPages = 1;

            document.addEventListener('DOMContentLoaded', function () {
                loadProducts();
                document.getElementById('editProductForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    updateProduct();
                });

                // 初始化拖拽排序
                initDragSort();
            });

            function toggleMode() {
                const searchTab = new bootstrap.Tab(document.getElementById('export-tab'));
                const isSearchActive = document.getElementById('search-tab').classList.contains('active');
                if (isSearchActive) {
                    searchTab.show();
                    document.getElementById('toggleModeBtn').innerHTML = '<i class="bi bi-arrow-left-right"></i> 切换到查询';
                } else {
                    const tab = new bootstrap.Tab(document.getElementById('search-tab'));
                    tab.show();
                    document.getElementById('toggleModeBtn').innerHTML = '<i class="bi bi-arrow-left-right"></i> 切换到导出';
                }
            }

            function loadProducts(page = 1, search = '') {
                const searchParam = search || document.getElementById('searchInput').value;
                const productDesc = document.getElementById('searchProductDesc').value;
                const salesperson = document.getElementById('searchSalesperson').value;
                const dateStart = document.getElementById('dateStart').value;
                const dateEnd = document.getElementById('dateEnd').value;
                const q = new URLSearchParams({
                    page: String(page), per_page: '10'
                });
                if (searchParam) q.append('search', searchParam);
                if (productDesc) q.append('product_desc', productDesc);
                if (salesperson) q.append('salesperson', salesperson);
                if (dateStart) q.append('date_start', dateStart);
                if (dateEnd) q.append('date_end', dateEnd);
                const url = `/product/list?${q.toString()}`;
                fetch(url)
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            displayProducts(data.data.products);
                            displayPagination(data.data.page, data.data.total_pages);
                            currentPage = data.data.page;
                            totalPages = data.data.total_pages;
                        } else {
                            showMessage(data.message, 'error');
                        }
                    })
                    .catch(err => showMessage('加载商品列表失败: ' + err.message, 'error'));
            }

            function resetSearch() {
                document.getElementById('searchInput').value = '';
                document.getElementById('searchProductDesc').value = '';
                document.getElementById('searchSalesperson').value = '';
                document.getElementById('dateStart').value = '';
                document.getElementById('dateEnd').value = '';
                loadProducts(1, '');
            }

            function searchProducts() {
                const s = document.getElementById('dateStart').value;
                const e = document.getElementById('dateEnd').value;
                if (s && e && s > e) {
                    showMessage('开始日期不能大于截止日期', 'error');
                    return;
                }
                loadProducts(1);
            }

            function displayProducts(products) {
                const tbody = document.getElementById('productTableBody');
                tbody.innerHTML = '';
                if (!products || products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="25" class="text-center">暂无数据</td></tr>';
                    return;
                }
                products.forEach(p => {
                    const docDate = p.doc_date || (p.create_time || '').slice(0,10);
                    const unitPrice = Number(p.unit_price ?? p.price ?? 0);
                    const qty = Number(p.quantity ?? 0);
                    const unitRate = Number(p.unit_discount_rate ?? 100);
                    const priceDiscounted = unitPrice * unitRate / 100.0;
                    const amount = (p.amount != null) ? Number(p.amount) : priceDiscounted * qty;
                    const orderRate = Number(p.order_discount_rate ?? 100);
                    const amountDiscounted = (p.amount_discounted != null) ? Number(p.amount_discounted) : amount * orderRate / 100.0;
                    const freight = Number(p.freight ?? 0);
                    const receivable = (p.receivable != null) ? Number(p.receivable) : (amountDiscounted + freight);
                    const paidTotal = Number(p.paid_total ?? 0);
                    const balance = (p.balance != null) ? Number(p.balance) : (receivable - paidTotal);

                    const productDesc = p.product_desc || `${p.name || ''}${p.spec ? ' ' + p.spec : ''}`.trim();
                    const unit = p.unit || p.spec || '';

                    const row = document.createElement('tr');
                    const extraEnc = encodeURIComponent(JSON.stringify(p));
                    row.innerHTML = `
                      <td>${docDate || '-'}</td>
                      <td>${p.customer_name || p.name || '-'}</td>
                      <td>${productDesc || '-'}</td>
                      <td>${unit || '-'}</td>
                      <td>${qty || 0}</td>
                      <td>${unitPrice.toFixed(2)}</td>
                      <td>${unitRate.toFixed(2)}</td>
                      <td>${priceDiscounted.toFixed(2)}</td>
                      <td>${amount.toFixed(2)}</td>
                      <td>${p.image_path ? `<img src="/uploads/thumb_${p.image_path}" class="product-image" onclick="viewImage('/uploads/${p.image_path}')">` : '<span class="text-muted">无</span>'}</td>
                      <td>${p.remark || ''}</td>
                      <td>${freight.toFixed(2)}</td>
                      <td>${orderRate.toFixed(2)}</td>
                      <td>${amountDiscounted.toFixed(2)}</td>
                      <td>${receivable.toFixed(2)}</td>
                      <td>${paidTotal.toFixed(2)}</td>
                      <td>${balance.toFixed(2)}</td>
                      <td>${p.settlement_account || ''}</td>
                      <td>${p.description || ''}</td>
                      <td>${p.salesperson || ''}</td>
                      <td>${p.update_time || ''}</td>
                      <td>${p.create_time || ''}</td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <button class="btn btn-outline-primary" onclick="editProductWithData('${extraEnc}')"><i class="bi bi-pencil"></i></button>
                          <button class="btn btn-outline-danger" onclick="deleteProduct(${p.id}, '${p.name}')"><i class="bi bi-trash"></i></button>
                        </div>
                      </td>`;
                    tbody.appendChild(row);
                });
            }

            function displayPagination(currentPage, totalPages) {
                const pagination = document.getElementById('pagination');
                pagination.innerHTML = '';
                if (totalPages <= 1) return;
                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
                prevLi.innerHTML = `<a class="page-link" href="#" onclick="loadProducts(${currentPage - 1})">上一页</a>`;
                pagination.appendChild(prevLi);
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                        const li = document.createElement('li');
                        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                        li.innerHTML = `<a class="page-link" href="#" onclick="loadProducts(${i})">${i}</a>`;
                        pagination.appendChild(li);
                    } else if (i === currentPage - 3 || i === currentPage + 3) {
                        const li = document.createElement('li');
                        li.className = 'page-item disabled';
                        li.innerHTML = '<span class="page-link">...</span>';
                        pagination.appendChild(li);
                    }
                }
                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
                nextLi.innerHTML = `<a class="page-link" href="#" onclick="loadProducts(${currentPage + 1})">下一页</a>`;
                pagination.appendChild(nextLi);
            }

            function exportProducts() {
                // 根据DOM顺序收集已勾选列
                const items = Array.from(document.querySelectorAll('#columnList > li'));
                const selected = [];
                items.forEach(li => {
                    const input = li.querySelector('input.col-check');
                    if (input && input.checked) selected.push(input.value);
                });
                if (selected.length === 0) return showMessage('请至少选择一列进行导出', 'error');
                // 携带当前筛选条件
                const filters = {
                    search: document.getElementById('searchInput').value || undefined,
                    product_desc: document.getElementById('searchProductDesc').value || undefined,
                    salesperson: document.getElementById('searchSalesperson').value || undefined,
                    date_start: document.getElementById('dateStart').value || undefined,
                    date_end: document.getElementById('dateEnd').value || undefined
                };
                fetch('/product/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ columns: selected, filters })
                })
                    .then(response => {
                        if (!response.ok) throw new Error('导出失败');
                        const cd = response.headers.get('Content-Disposition');
                        let filename = '';
                        if (cd) {
                            const m = cd.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                            if (m && m[1]) filename = m[1].replace(/['"]/g, '');
                        }
                        if (!filename) filename = `products_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.xlsx`;
                        return response.blob().then(blob => ({ blob, filename }));
                    })
                    .then(({ blob, filename }) => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        URL.revokeObjectURL(url);
                        a.remove();
                        showMessage('导出成功', 'success');
                    })
                    .catch(err => showMessage('导出失败: ' + err.message, 'error'));
            }

            // 提供一个按钮调用的封装，效果等同 exportProducts
            function exportWithFilters() { exportProducts(); }

            function showMessage(message, type = 'info') {
                const toast = document.getElementById('messageToast');
                const toastMessage = document.getElementById('toastMessage');
                toastMessage.textContent = message;
                toast.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');
                switch (type) {
                    case 'success': toast.classList.add('bg-success', 'text-white'); break;
                    case 'error': toast.classList.add('bg-danger', 'text-white'); break;
                    case 'warning': toast.classList.add('bg-warning'); break;
                    default: toast.classList.add('bg-info', 'text-white');
                }
                new bootstrap.Toast(toast).show();
            }

            function editProduct(id, name, price, quantity, spec, imagePath, extra = {}) {
                document.getElementById('editProductId').value = id;
                document.getElementById('editDocDate').value = (extra.doc_date || '').slice(0,10);
                document.getElementById('editName').value = extra.customer_name || name || '';
                document.getElementById('editProductDesc').value = extra.product_desc || '';
                document.getElementById('editPrice').value = price;
                document.getElementById('editQuantity').value = quantity;
                document.getElementById('editSpec').value = extra.unit || spec || '';
                document.getElementById('editFreight').value = extra.freight || 0;
                document.getElementById('editPaidTotal').value = extra.paid_total || 0;
                document.getElementById('editRemark').value = extra.remark || '';
                document.getElementById('editSettlement').value = extra.settlement_account || '';
                document.getElementById('editDescription').value = extra.description || '';
                const current = document.getElementById('currentImageDisplay');
                current.innerHTML = imagePath ? `<img src="/uploads/thumb_${imagePath}" class="product-image" onclick="viewImage('/uploads/${imagePath}')">` : '<span class="text-muted">无图片</span>';
                const del = document.getElementById('editDeleteImage');
                if (del) del.checked = false;
                new bootstrap.Modal(document.getElementById('editProductModal')).show();
            }

            function editProductWithData(enc) {
                try {
                    const extra = JSON.parse(decodeURIComponent(enc));
                    editProduct(extra.id, extra.name, extra.price, extra.quantity, extra.spec || '', extra.image_path || '', extra);
                } catch (e) { console.error(e); }
            }

            function deleteProduct(id, name) {
                if (!confirm(`确定删除商品"${name}"？`)) return;
                fetch('/product/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                })
                    .then(r => r.json())
                    .then(d => {
                        if (d.success) { showMessage(d.message, 'success'); loadProducts(currentPage); }
                        else showMessage(d.message, 'error');
                    })
                    .catch(err => showMessage('删除失败: ' + err.message, 'error'));
            }

            function updateProduct() {
                const formData = new FormData(document.getElementById('editProductForm'));
                fetch('/product/update', { method: 'POST', body: formData })
                    .then(r => r.json())
                    .then(d => {
                        if (d.success) {
                            showMessage(d.message, 'success');
                            bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
                            loadProducts(currentPage);
                        } else showMessage(d.message, 'error');
                    })
                    .catch(err => showMessage('更新失败: ' + err.message, 'error'));
            }

            function viewImage(imageUrl) {
                const img = document.getElementById('fullSizeImage');
                const link = document.getElementById('downloadImageLink');
                img.src = '';
                img.alt = '加载中...';
                img.style.opacity = '0.5';
                img.src = imageUrl;
                link.href = imageUrl;
                img.onload = function () { img.style.opacity = '1'; img.alt = '商品原图'; };
                img.onerror = function () { img.alt = '图片加载失败'; img.style.opacity = '0.3'; showMessage('图片加载失败', 'error'); };
                new bootstrap.Modal(document.getElementById('imageViewModal')).show();
            }

            function toggleAllColumns(checked) {
                document.querySelectorAll('#columnList input.col-check').forEach(cb => cb.checked = checked);
            }

            // 简易拖拽排序实现
            function initDragSort() {
                const list = document.getElementById('columnList');
                list.addEventListener('dragstart', (e) => {
                    const li = e.target.closest('li.draggable-item');
                    if (!li) return;
                    li.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });
                list.addEventListener('dragend', (e) => {
                    const li = e.target.closest('li.draggable-item');
                    if (!li) return;
                    li.classList.remove('dragging');
                });
                list.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(list, e.clientY);
                    const dragging = list.querySelector('.dragging');
                    if (!dragging) return;
                    if (afterElement == null) {
                        list.appendChild(dragging);
                    } else {
                        list.insertBefore(dragging, afterElement);
                    }
                });
                // 勾选监听
                list.addEventListener('change', (e) => {
                    if (e.target && e.target.classList.contains('col-check')) {
                        // no-op, wait save
                    }
                });
                // 初始化：从服务端读取配置
                loadColumnsFromServer();
            }

            function getDragAfterElement(container, y) {
                const els = [...container.querySelectorAll('li.draggable-item:not(.dragging)')];
                return els.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
            async function saveColumnsToServer(){
                try{
                    const items = Array.from(document.querySelectorAll('#columnList > li.draggable-item'));
                    const payload = items.map(li => ({ key: li.getAttribute('data-key'), checked: !!li.querySelector('input.col-check')?.checked }));
                    const resp = await fetch('/product/columns/save', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ columns: payload }) });
                    const data = await resp.json();
                    if (!data.success) throw new Error(data.message || '保存失败');
                    showMessage('列设置已保存', 'success');
                }catch(e){ showMessage(e.message || '保存失败', 'error'); }
            }

            async function loadColumnsFromServer(){
                try{
                    const resp = await fetch('/product/columns/load');
                    const data = await resp.json();
                    if (!data.success) return;
                    const cfg = data.data || [];
                    if (!Array.isArray(cfg) || cfg.length === 0) return;
                    const list = document.getElementById('columnList');
                    cfg.forEach(c => {
                        const li = list.querySelector(`li.draggable-item[data-key="${c.key}"]`);
                        if (li) list.appendChild(li);
                    });
                    cfg.forEach(c => {
                        const li = document.querySelector(`#columnList li[data-key="${c.key}"]`);
                        const cb = li ? li.querySelector('input.col-check') : null;
                        if (cb) cb.checked = !!c.checked;
                    });
                }catch(e){ /* 忽略 */ }
            }
            
            function logout() {
                fetch('/auth/logout', { method: 'POST' })
                    .then(r => r.json())
                    .then(() => { window.location.href = '/auth/login'; })
                    .catch(() => { window.location.href = '/auth/login'; });
            }
        </script>
    </body>
</html>

