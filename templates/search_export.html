<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>查询与导出 - 商品信息管理</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet" />
        <style>
            .product-image { max-width: 80px; max-height: 80px; object-fit: cover; cursor: pointer; }
            .nav-tabs .nav-link.active { font-weight: 600; }
            /* 顶部导航：居中+高亮 */
            .navbar .navbar-nav { gap: 1.25rem; }
            .navbar .nav-link { color: rgba(255,255,255,.7); font-weight: 600; }
            .navbar .nav-link.active {
                color: #fff !important;
                background-color: #0d6efd;
                border-radius: .5rem;
                padding: .25rem .85rem;
                box-shadow: 0 0 .6rem rgba(13,110,253,.55);
            }
            .navbar .nav-link:hover { color: #fff; }
        </style>
    </head>
    <body class="bg-light">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">商品管理</a>
                <div class="navbar-nav mx-auto flex-row">
                    <a class="nav-link active" aria-current="page" href="/search">查询/导出</a>
                    <a class="nav-link" href="/entry">录入</a>
                </div>
            </div>
        </nav>

        <div class="container py-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0"><i class="bi bi-search"></i> 查询与导出</h3>
                <div>
                    <button class="btn btn-outline-secondary btn-sm" id="toggleModeBtn" onclick="toggleMode()">
                        <i class="bi bi-arrow-left-right"></i> 切换到导出
                    </button>
                </div>
            </div>

            <ul class="nav nav-tabs mb-3" id="modeTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-pane" type="button" role="tab">查询</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="export-tab" data-bs-toggle="tab" data-bs-target="#export-pane" type="button" role="tab">导出</button>
                </li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="search-pane" role="tabpanel">
                    <div class="row g-3 align-items-end mb-3">
                        <div class="col-md-4">
                            <label class="form-label">按商品名称</label>
                            <input class="form-control" id="searchInput" placeholder="支持模糊查询" />
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary" onclick="searchProducts()"><i class="bi bi-search"></i> 查询</button>
                            <button class="btn btn-outline-secondary" onclick="resetSearch()"><i class="bi bi-x-lg"></i> 重置</button>
                        </div>
                    </div>

                    <div class="table-responsive bg-white rounded shadow-sm p-3">
                        <table class="table table-striped align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>图片</th>
                                    <th>名称</th>
                                    <th>价格</th>
                                    <th>数量</th>
                                    <th>规格</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="productTableBody"></tbody>
                        </table>
                        <nav aria-label="分页"><ul class="pagination justify-content-center" id="pagination"></ul></nav>
                    </div>
                </div>

                <div class="tab-pane fade" id="export-pane" role="tabpanel">
                    <div class="bg-white rounded shadow-sm p-3">
                        <h5 class="mb-3"><i class="bi bi-download"></i> 导出Excel</h5>
                        <div class="row g-2 align-items-center">
                            <div class="col-12 col-md-8">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="col_name" value="name" checked>
                                    <label class="form-check-label" for="col_name">商品名称</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="col_price" value="price" checked>
                                    <label class="form-check-label" for="col_price">价格</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="col_quantity" value="quantity" checked>
                                    <label class="form-check-label" for="col_quantity">数量</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="col_spec" value="spec">
                                    <label class="form-check-label" for="col_spec">规格</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="col_image" value="image_path">
                                    <label class="form-check-label" for="col_image">图片</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="col_time" value="create_time">
                                    <label class="form-check-label" for="col_time">创建时间</label>
                                </div>
                            </div>
                            <div class="col-12 col-md-4 text-md-end">
                                <button class="btn btn-success" onclick="exportProducts()"><i class="bi bi-file-earmark-excel"></i> 导出</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 编辑模态框复用 -->
        <div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-pencil"></i> 修改商品</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form id="editProductForm" enctype="multipart/form-data">
                        <div class="modal-body">
                            <input type="hidden" id="editProductId" name="id" />
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">名称 *</label>
                                    <input class="form-control" id="editName" name="name" required />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">价格 *</label>
                                    <input type="number" step="0.01" min="0" class="form-control" id="editPrice" name="price" required />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">数量 *</label>
                                    <input type="number" min="0" class="form-control" id="editQuantity" name="quantity" required />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">规格</label>
                                    <input class="form-control" id="editSpec" name="spec" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">新图片</label>
                                    <input type="file" class="form-control" id="editImage" name="image" accept="image/*" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">当前图片</label>
                                    <div id="currentImageDisplay" class="border rounded p-2 text-center"><span class="text-muted">无图片</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-check"></i> 保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 查看图片模态框 -->
        <div class="modal fade" id="imageViewModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-image"></i> 商品图片</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img id="fullSizeImage" src="" alt="商品原图" class="img-fluid" style="max-height: 80vh" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        <a id="downloadImageLink" href="" download class="btn btn-primary"><i class="bi bi-download"></i> 下载图片</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="messageToast" class="toast" role="alert">
                <div class="toast-header">
                    <strong class="me-auto">系统消息</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            let currentPage = 1;
            let totalPages = 1;

            document.addEventListener('DOMContentLoaded', function () {
                loadProducts();
                document.getElementById('editProductForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    updateProduct();
                });
            });

            function toggleMode() {
                const searchTab = new bootstrap.Tab(document.getElementById('export-tab'));
                const isSearchActive = document.getElementById('search-tab').classList.contains('active');
                if (isSearchActive) {
                    searchTab.show();
                    document.getElementById('toggleModeBtn').innerHTML = '<i class="bi bi-arrow-left-right"></i> 切换到查询';
                } else {
                    const tab = new bootstrap.Tab(document.getElementById('search-tab'));
                    tab.show();
                    document.getElementById('toggleModeBtn').innerHTML = '<i class="bi bi-arrow-left-right"></i> 切换到导出';
                }
            }

            function loadProducts(page = 1, search = '') {
                const searchParam = search || document.getElementById('searchInput').value;
                const url = `/product/list?page=${page}&per_page=10${searchParam ? '&search=' + encodeURIComponent(searchParam) : ''}`;
                fetch(url)
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            displayProducts(data.data.products);
                            displayPagination(data.data.page, data.data.total_pages);
                            currentPage = data.data.page;
                            totalPages = data.data.total_pages;
                        } else {
                            showMessage(data.message, 'error');
                        }
                    })
                    .catch(err => showMessage('加载商品列表失败: ' + err.message, 'error'));
            }

            function resetSearch() {
                document.getElementById('searchInput').value = '';
                loadProducts(1, '');
            }

            function searchProducts() { loadProducts(1); }

            function displayProducts(products) {
                const tbody = document.getElementById('productTableBody');
                tbody.innerHTML = '';
                if (!products || products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">暂无数据</td></tr>';
                    return;
                }
                products.forEach(product => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${product.id}</td>
                        <td>${product.image_path ? `<img src="/uploads/thumb_${product.image_path}" class="product-image" onclick="viewImage('/uploads/${product.image_path}')">` : '<span class="text-muted">无</span>'}</td>
                        <td>${product.name}</td>
                        <td>¥${parseFloat(product.price).toFixed(2)}</td>
                        <td>${product.quantity}</td>
                        <td>${product.spec || '-'}</td>
                        <td>${product.create_time || '-'}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editProduct(${product.id}, '${product.name}', ${product.price}, ${product.quantity}, '${product.spec || ''}', '${product.image_path || ''}')"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-outline-danger" onclick="deleteProduct(${product.id}, '${product.name}')"><i class="bi bi-trash"></i></button>
                            </div>
                        </td>`;
                    tbody.appendChild(row);
                });
            }

            function displayPagination(currentPage, totalPages) {
                const pagination = document.getElementById('pagination');
                pagination.innerHTML = '';
                if (totalPages <= 1) return;
                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
                prevLi.innerHTML = `<a class="page-link" href="#" onclick="loadProducts(${currentPage - 1})">上一页</a>`;
                pagination.appendChild(prevLi);
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                        const li = document.createElement('li');
                        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                        li.innerHTML = `<a class="page-link" href="#" onclick="loadProducts(${i})">${i}</a>`;
                        pagination.appendChild(li);
                    } else if (i === currentPage - 3 || i === currentPage + 3) {
                        const li = document.createElement('li');
                        li.className = 'page-item disabled';
                        li.innerHTML = '<span class="page-link">...</span>';
                        pagination.appendChild(li);
                    }
                }
                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
                nextLi.innerHTML = `<a class="page-link" href="#" onclick="loadProducts(${currentPage + 1})">下一页</a>`;
                pagination.appendChild(nextLi);
            }

            function exportProducts() {
                const selected = Array.from(document.querySelectorAll('#export-pane input[type="checkbox"]:checked')).map(cb => cb.value);
                if (selected.length === 0) return showMessage('请至少选择一列进行导出', 'error');
                fetch('/product/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ columns: selected })
                })
                    .then(response => {
                        if (!response.ok) throw new Error('导出失败');
                        const cd = response.headers.get('Content-Disposition');
                        let filename = '';
                        if (cd) {
                            const m = cd.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                            if (m && m[1]) filename = m[1].replace(/['"]/g, '');
                        }
                        if (!filename) filename = `products_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.xlsx`;
                        return response.blob().then(blob => ({ blob, filename }));
                    })
                    .then(({ blob, filename }) => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        URL.revokeObjectURL(url);
                        a.remove();
                        showMessage('导出成功', 'success');
                    })
                    .catch(err => showMessage('导出失败: ' + err.message, 'error'));
            }

            function showMessage(message, type = 'info') {
                const toast = document.getElementById('messageToast');
                const toastMessage = document.getElementById('toastMessage');
                toastMessage.textContent = message;
                toast.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');
                switch (type) {
                    case 'success': toast.classList.add('bg-success', 'text-white'); break;
                    case 'error': toast.classList.add('bg-danger', 'text-white'); break;
                    case 'warning': toast.classList.add('bg-warning'); break;
                    default: toast.classList.add('bg-info', 'text-white');
                }
                new bootstrap.Toast(toast).show();
            }

            function editProduct(id, name, price, quantity, spec, imagePath) {
                document.getElementById('editProductId').value = id;
                document.getElementById('editName').value = name;
                document.getElementById('editPrice').value = price;
                document.getElementById('editQuantity').value = quantity;
                document.getElementById('editSpec').value = spec || '';
                const current = document.getElementById('currentImageDisplay');
                current.innerHTML = imagePath ? `<img src="/uploads/thumb_${imagePath}" class="product-image" onclick="viewImage('/uploads/${imagePath}')">` : '<span class="text-muted">无图片</span>';
                new bootstrap.Modal(document.getElementById('editProductModal')).show();
            }

            function deleteProduct(id, name) {
                if (!confirm(`确定删除商品"${name}"？`)) return;
                fetch('/product/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                })
                    .then(r => r.json())
                    .then(d => {
                        if (d.success) { showMessage(d.message, 'success'); loadProducts(currentPage); }
                        else showMessage(d.message, 'error');
                    })
                    .catch(err => showMessage('删除失败: ' + err.message, 'error'));
            }

            function updateProduct() {
                const formData = new FormData(document.getElementById('editProductForm'));
                fetch('/product/update', { method: 'POST', body: formData })
                    .then(r => r.json())
                    .then(d => {
                        if (d.success) {
                            showMessage(d.message, 'success');
                            bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
                            loadProducts(currentPage);
                        } else showMessage(d.message, 'error');
                    })
                    .catch(err => showMessage('更新失败: ' + err.message, 'error'));
            }

            function viewImage(imageUrl) {
                const img = document.getElementById('fullSizeImage');
                const link = document.getElementById('downloadImageLink');
                img.src = '';
                img.alt = '加载中...';
                img.style.opacity = '0.5';
                img.src = imageUrl;
                link.href = imageUrl;
                img.onload = function () { img.style.opacity = '1'; img.alt = '商品原图'; };
                img.onerror = function () { img.alt = '图片加载失败'; img.style.opacity = '0.3'; showMessage('图片加载失败', 'error'); };
                new bootstrap.Modal(document.getElementById('imageViewModal')).show();
            }
        </script>
    </body>
</html>

