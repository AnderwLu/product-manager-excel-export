<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>查询与编辑 - 商品信息管理</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet" />
        <style>
            body { padding-top: 64px; }
            .product-image { max-width: 80px; max-height: 80px; object-fit: cover; cursor: pointer; }
            .nav-tabs .nav-link.active { font-weight: 600; }
            .navbar .navbar-nav { gap: 1.25rem; }
            .navbar .nav-link { color: rgba(255,255,255,.7); font-weight: 600; }
            .navbar .nav-link.active { color: #fff !important; background-color: #0d6efd; border-radius: .5rem; padding: .25rem .85rem; box-shadow: 0 0 .6rem rgba(13,110,253,.55); }
            .navbar .nav-link:hover { color: #fff; }
            .table-nowrap th, .table-nowrap td { white-space: nowrap; }
            .changed { background-color: #e7f5ff !important; }
            /* 默认让容器自适应高度，避免将分页切到中间 */
            #grid { height: auto; overflow: visible; }
            .tabulator-cell .btn { padding: .1rem .4rem; font-size: .75rem; }
            /* 分页条固定到底部且靠右 */
            /* 分页条置于内容之后，避免遮挡 */
            .pager-bar { position: static; background: #fff; padding-top: .5rem; border-top: 1px solid #eee; }
            .grid-card { padding-bottom: .5rem; }
            /* 降级表格时为关键输入列提供更宽显示 */
            #fallbackTable td:nth-child(2) input,   /* 客户名称 */
            #fallbackTable td:nth-child(3) input,   /* 品名规格 */
            #fallbackTable td:nth-child(4) input,   /* 单位 */
            #fallbackTable td:nth-child(5) input,   /* 数量 */
            #fallbackTable td:nth-child(6) input,   /* 单价 */
            #fallbackTable td:nth-child(11) input,  /* 备注 */
            #fallbackTable td:nth-child(12) input,  /* 运费 */
            #fallbackTable td:nth-child(16) input,  /* 已收款 */
            #fallbackTable td:nth-child(18) input,  /* 结算账户 */
            #fallbackTable td:nth-child(19) input   /* 说明 */
            { min-width: 140px; }
            /* 列宽自动，随内容而定，容器可横向滚动 */
            #fallbackTable { table-layout: auto; }
            #fallbackTable th, #fallbackTable td { min-width: auto; }
            #fallbackTable th.col-image_path, #fallbackTable td.col-image_path,
            #fallbackTable th.col-image, #fallbackTable td.col-image { min-width: auto; }
            #fallbackTable th.col-update_time, #fallbackTable td.col-update_time,
            #fallbackTable th.col-create_time, #fallbackTable td.col-create_time { min-width: auto; }
            #fallbackTable td.col-image_path img, #fallbackTable td.col-image img { max-width: 160px; height: auto; display: block; }
            /* 统一缩略图尺寸 */
            .thumb-fixed { width: 80px; height: 60px; object-fit: contain; border-radius: 4px; cursor: pointer; background-color: #fff; display: inline-block; }
            /* 输入自适应：使用字符宽度，不限制在单元格内 */
            #fallbackTable input.form-control { width: auto !important; box-sizing: content-box; display: inline-block; }
            /* 图片弹框样式 */
            .image-modal-img { max-width: 100%; height: auto; display: block; margin: 0 auto; }
            .image-modal-body { text-align: center; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        </style>
    </head>
    <body class="bg-light">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">商品管理</a>
                <div class="navbar-nav mx-auto flex-row">
                    <a class="nav-link active" aria-current="page" href="/search-edit">查询/编辑</a>
                    <a class="nav-link" href="/search">查询/导出</a>
                    <a class="nav-link" href="/entry">录入</a>
                    <a class="nav-link" href="/auth/users">用户管理</a>
                </div>
                <div class="d-flex align-items-center">
                    <span class="text-white-50 me-3">{{ (session.get('real_name') or session.get('username')) or '' }}</span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">退出</button>
                </div>
            </div>
        </nav>

        <div class="container py-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0"><i class="bi bi-pencil-square"></i> 查询与编辑</h3>
            </div>

            <div class="alert alert-info py-2">
                说明：查询结果单元格可直接编辑，修改将自动保存。
            </div>

            <div class="row g-3 align-items-end mb-3">
                <div class="col-md-3">
                    <label class="form-label">客户名称(模糊)</label>
                    <input class="form-control" id="searchInput" placeholder="客户名称" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">品名规格(模糊)</label>
                    <input class="form-control" id="searchProductDesc" placeholder="品名规格" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">营业员(模糊)</label>
                    <input class="form-control" id="searchSalesperson" placeholder="营业员" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">单据日期(起止)</label>
                    <div class="d-flex gap-1">
                        <input type="date" class="form-control" id="dateStart" />
                        <span class="align-self-center">~</span>
                        <input type="date" class="form-control" id="dateEnd" />
                    </div>
                </div>
                <div class="col-md-12">
                    <button class="btn btn-primary me-2" onclick="searchProducts()"><i class="bi bi-search"></i> 查询</button>
                    <button class="btn btn-outline-secondary me-2" onclick="resetSearch()"><i class="bi bi-x-lg"></i> 重置</button>
                    <button class="btn btn-success" onclick="exportCurrent()"><i class="bi bi-file-earmark-excel"></i> 导出</button>
                </div>
            </div>

            <div class="bg-white rounded shadow-sm p-3 position-relative grid-card">
                <div id="grid"></div>
                <div class="clearfix"></div>
                <nav aria-label="分页" class="pager-bar"><ul class="pagination justify-content-end m-0" id="pagination"></ul></nav>
            </div>
        </div>

        <!-- 图片查看/编辑弹框 -->
        <div class="modal fade" id="imageViewerModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">图片预览</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body image-modal-body">
                        <img id="imageModalPreview" class="image-modal-img" alt="预览" />
                        <div id="imageModalEmpty" class="text-muted d-none">当前无图片</div>
                    </div>
                    <div class="modal-footer">
                        <button id="btnModalAddOrChange" type="button" class="btn btn-primary">添加/更换</button>
                        <button id="btnModalDelete" type="button" class="btn btn-outline-danger">删除</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="messageToast" class="toast" role="alert">
                <div class="toast-header">
                    <strong class="me-auto">系统消息</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            let currentPage = 1;
            let totalPages = 1;
            const dirtyMap = new Map(); // id -> partial fields
            let grid = null;
            let useFallback = false; // 当 Tabulator 不可用时启用降级渲染
            const allowedFields = new Set(['doc_date','customer_name','product_desc','unit','quantity','unit_price','unit_discount_rate','remark','freight','order_discount_rate','paid_total','settlement_account','description']);
            let rowCache = new Map(); // id -> latest row data
            let imageModal = null;
            let currentImageRowId = null;

            // 基础列定义（用于首访或服务端未返回时的默认渲染）
            const BASE_COLUMNS = [
                { key: 'doc_date', title: '单据日期' },
                { key: 'customer_name', title: '客户名称' },
                { key: 'product_desc', title: '品名规格' },
                { key: 'unit', title: '单位' },
                { key: 'quantity', title: '数量' },
                { key: 'unit_price', title: '单价' },
                { key: 'unit_discount_rate', title: '单价折扣率(%)' },
                { key: 'unit_price_discounted', title: '折后单价' },
                { key: 'amount', title: '金额' },
                { key: 'image_path', title: '图片' },
                { key: 'remark', title: '备注' },
                { key: 'freight', title: '运费' },
                { key: 'order_discount_rate', title: '整单折扣率(%)' },
                { key: 'amount_discounted', title: '折后金额' },
                { key: 'receivable', title: '应收款' },
                { key: 'paid_total', title: '已收款' },
                { key: 'balance', title: '尾款' },
                { key: 'settlement_account', title: '结算账户' },
                { key: 'description', title: '说明' },
                { key: 'salesperson', title: '营业员' },
                { key: 'update_time', title: '修改时间' },
                { key: 'create_time', title: '创建时间' }
            ];

            // 读取当前激活列（优先使用本地存储/服务端返回），否则回落到全量默认列
            function getActiveColumns(){
                try {
                    const stored = JSON.parse(localStorage.getItem('edit_columns') || 'null');
                    if (Array.isArray(stored) && stored.length) return stored;
                } catch(e) {}
                return BASE_COLUMNS.map(c => ({ ...c, hidden: false }));
            }

            // 将导出页的键名映射到查询编辑内部键名
            function normalizeKey(k){
                if (k === 'name') return 'product_desc';
                if (k === 'image') return 'image_path';
                return k;
            }

            document.addEventListener('DOMContentLoaded', async function () {
                await syncColumnsFromServer();
                if (typeof Tabulator === 'undefined') {
                    useFallback = true;
                    initFallbackGrid();
                    loadProducts();
                } else {
                    initGrid();
                    loadProducts();
                }
                // 初始化图片弹框
                const modalEl = document.getElementById('imageViewerModal');
                if (modalEl) {
                    imageModal = new bootstrap.Modal(modalEl);
                    document.getElementById('btnModalAddOrChange')?.addEventListener('click', () => {
                        if (currentImageRowId == null) return;
                        triggerImagePick(currentImageRowId);
                    });
                    document.getElementById('btnModalDelete')?.addEventListener('click', () => {
                        if (currentImageRowId == null) return;
                        deleteImageFromModal(currentImageRowId);
                    });
                }
            });

            function initGrid() {
                grid = new Tabulator('#grid', {
                    data: [],
                    layout: 'fitData',
                    index: 'id',
                    reactiveData: false,
                    columnDefaults: { headerHozAlign: 'center', vertAlign: 'middle' },
                    columns: [
                        { title: '单据日期', field: 'doc_date', editor: 'input', editorParams: { elementAttributes: { type: 'date' } } },
                        { title: '客户名称', field: 'customer_name', editor: 'input' },
                        { title: '品名规格', field: 'product_desc', editor: 'input' },
                        { title: '单位', field: 'unit', editor: 'input' },
                        { title: '数量', field: 'quantity', editor: 'number' },
                        { title: '单价', field: 'unit_price', editor: 'number', formatter: decimal2 },
                        { title: '单价折扣率(%)', field: 'unit_discount_rate', editor: 'number', formatter: decimal2 },
                        { title: '折后单价', field: 'unit_price_discounted', hozAlign: 'right', formatter: function(cell){ return toFixed2(calcUnitPriceDiscounted(cell.getRow().getData())); } },
                        { title: '金额', field: 'amount', hozAlign: 'right', formatter: function(cell){ return toFixed2(calcAmount(cell.getRow().getData())); } },
                        { title: '图片', field: 'image_path', hozAlign: 'center', headerSort: false, formatter: imageFormatter, cellClick: function(e, cell){ const d = cell.getRow().getData(); if (d && d.id != null) openImageModalById(d.id); } },
                        { title: '备注', field: 'remark', editor: 'input' },
                        { title: '运费', field: 'freight', editor: 'number', formatter: decimal2 },
                        { title: '整单折扣率(%)', field: 'order_discount_rate', editor: 'number', formatter: decimal2 },
                        { title: '折后金额', field: 'amount_discounted', hozAlign: 'right', formatter: function(cell){ return toFixed2(calcAmountDiscounted(cell.getRow().getData())); } },
                        { title: '应收款', field: 'receivable', hozAlign: 'right', formatter: function(cell){ return toFixed2(calcReceivable(cell.getRow().getData())); } },
                        { title: '已收款', field: 'paid_total', editor: 'number', formatter: decimal2 },
                        { title: '尾款', field: 'balance', hozAlign: 'right', formatter: function(cell){ return toFixed2(calcBalance(cell.getRow().getData())); } },
                        { title: '结算账户', field: 'settlement_account', editor: 'input' },
                        { title: '说明', field: 'description', editor: 'input' },
                        { title: '营业员', field: 'salesperson' },
                        { title: '修改时间', field: 'update_time' },
                        { title: '创建时间', field: 'create_time' },
                        { title: '操作', field: 'actions', headerSort: false, hozAlign: 'center', formatter: function(cell){
                            const d = cell.getRow().getData();
                            const id = d && d.id != null ? d.id : '';
                            const name = (d && (d.customer_name || d.name)) || '';
                            return `<button class="btn btn-outline-danger btn-sm" onclick="deleteProduct(${id}, '${name.replace(/'/g, "\\'")}')"><i class='bi bi-trash'></i></button>`;
                        }},
                    ],
                    cellEdited: function(cell){
                        const field = cell.getField();
                        if (!allowedFields.has(field)) return;
                        const row = cell.getRow();
                        const id = row.getIndex();
                        let val = cell.getValue();
                        if (typeof val === 'string' && val.trim() === '') val = null;
                        const oldVal = (typeof cell.getOldValue === 'function') ? cell.getOldValue() : undefined;
                        // 先本地刷新计算列（不等待网络）
                        const base = rowCache.get(id) || {};
                        base[field] = val;
                        rowCache.set(id, base);
                        try { row.reformat(); } catch(e) {}
                        row.getElement().classList.add('changed');
                        // 再异步保存
                        savePartialUpdate(id, { [field]: val })
                          .then(() => { /* 已本地刷新，无额外操作 */ })
                          .catch(err => {
                              showMessage('保存失败: ' + (err.message || err), 'error');
                              // 回滚显示与缓存
                              if (oldVal !== undefined) {
                                  const patch = {}; patch[field] = oldVal;
                                  row.update(patch);
                                  const cached = rowCache.get(id) || {};
                                  cached[field] = oldVal;
                                  rowCache.set(id, cached);
                                  try { row.reformat(); } catch(e) {}
                              }
                          });
                    }
                });
            }

            function savePartialUpdate(id, fields){
                return fetch('/product/batch_update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: [{ id, fields }] })
                }).then(r => r.json()).then(d => {
                    if (!d || d.success !== true) { throw new Error(d && d.message || '保存失败'); }
                    return d;
                });
            }

            function imageFormatter(cell){
                const data = cell.getRow().getData();
                const has = !!data.image_path;
                const imgHtml = has
                    ? `<img src="/uploads/thumb_${data.image_path}" class="thumb-fixed" onclick="openImageModalById(${data.id})">`
                    : `<button class="btn btn-sm btn-outline-primary" onclick="openImageModalById(${data.id})">添加图片</button>`;
                return `${imgHtml}`;
            }

            function openImageModalById(id){
                currentImageRowId = id;
                const data = getRowData(id);
                const imgEl = document.getElementById('imageModalPreview');
                const emptyEl = document.getElementById('imageModalEmpty');
                if (!imgEl || !emptyEl || !imageModal) return;
                if (data && data.image_path) {
                    imgEl.src = `/uploads/${data.image_path}`;
                    imgEl.classList.remove('d-none');
                    emptyEl.classList.add('d-none');
                    document.getElementById('btnModalAddOrChange').textContent = '更换图片';
                    document.getElementById('btnModalDelete').classList.remove('d-none');
                } else {
                    imgEl.src = '';
                    imgEl.classList.add('d-none');
                    emptyEl.classList.remove('d-none');
                    document.getElementById('btnModalAddOrChange').textContent = '添加图片';
                    document.getElementById('btnModalDelete').classList.add('d-none');
                }
                imageModal.show();
            }

            function getRowData(id){
                if (!useFallback) {
                    const row = grid.getRow(id);
                    return row ? row.getData() : rowCache.get(id);
                }
                return rowCache.get(id);
            }

            function setRowImagePath(id, filename){
                const row = getRow(id);
                if (row) {
                    row.update({ image_path: filename || null });
                    // Tabulator 行对象具备 reformat，用于强制按 formatter 重绘
                    if (!useFallback && typeof row.reformat === 'function') {
                        try { row.reformat(); } catch(e) {}
                    }
                }
                const d = rowCache.get(id) || {};
                d.image_path = filename || null;
                rowCache.set(id, d);
                if (currentImageRowId === id) {
                    // 同步弹框UI
                    openImageModalById(id);
                }
            }

            function triggerImagePick(id){
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = () => {
                    const file = input.files && input.files[0];
                    if (!file) return;
                    const fd = new FormData();
                    fd.append('id', String(id));
                    fd.append('image', file);
                    fetch('/product/update_image', { method: 'POST', body: fd })
                      .then(r => r.json())
                      .then(d => {
                          if (!d.success) return showMessage(d.message || '图片更新失败', 'error');
                          showMessage('图片更新成功', 'success');
                          setRowImagePath(id, d.filename || null);
                      })
                      .catch(err => showMessage('图片更新失败: ' + err.message, 'error'));
                };
                input.click();
            }

            function deleteImageFromModal(id){
                if (!confirm('确定删除该行图片？')) return;
                const fd = new FormData();
                fd.append('id', String(id));
                fd.append('delete_image', '1');
                fetch('/product/update_image', { method: 'POST', body: fd })
                  .then(r => r.json())
                  .then(d => {
                      if (!d.success) return showMessage(d.message || '删除失败', 'error');
                      showMessage('图片已删除', 'success');
                      setRowImagePath(id, null);
                  })
                  .catch(err => showMessage('删除失败: ' + err.message, 'error'));
            }

            function onChangeImage(id){ triggerImagePick(id); }

            function onDeleteImage(id){ deleteImageFromModal(id); }

            function loadProducts(page = 1) {
                const q = new URLSearchParams({ page: String(page), per_page: '10' });
                const searchParam = document.getElementById('searchInput').value;
                const productDesc = document.getElementById('searchProductDesc').value;
                const salesperson = document.getElementById('searchSalesperson').value;
                const dateStart = document.getElementById('dateStart').value;
                const dateEnd = document.getElementById('dateEnd').value;
                if (searchParam) q.append('search', searchParam);
                if (productDesc) q.append('product_desc', productDesc);
                if (salesperson) q.append('salesperson', salesperson);
                if (dateStart) q.append('date_start', dateStart);
                if (dateEnd) q.append('date_end', dateEnd);
                fetch(`/product/list?${q.toString()}`)
                    .then(r => r.json())
                    .then(d => {
                        if (!d.success) return showMessage(d.message, 'error');
                        const products = (d.data.products || []).map(normalizeRow);
                        // 更新缓存
                        rowCache = new Map(products.map(p => [p.id, { ...p }]));
                        gridReplaceData(products);
                        displayPagination(d.data.page, d.data.total_pages);
                        currentPage = d.data.page; totalPages = d.data.total_pages;
                    })
                    .catch(err => showMessage('加载失败: ' + err.message, 'error'));
            }

            function deleteProduct(id, name){
                const displayName = name || ((rowCache.get(id) || {}).customer_name) || '';
                if (!confirm(`确定删除该条记录${displayName ? `（${displayName}）` : ''}？`)) return;
                fetch('/product/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                })
                  .then(r => r.json())
                  .then(d => {
                      if (d && d.success) { showMessage(d.message || '删除成功', 'success'); loadProducts(currentPage); }
                      else { showMessage((d && d.message) || '删除失败', 'error'); }
                  })
                  .catch(err => showMessage('删除失败: ' + err.message, 'error'));
            }

            function normalizeRow(p){
                return Object.assign({}, p, {
                    unit: (p.unit || p.spec || ''),
                    unit_price: Number(p.unit_price ?? p.price ?? 0),
                });
            }

            function searchProducts() {
                const s = document.getElementById('dateStart').value;
                const e = document.getElementById('dateEnd').value;
                if (s && e && s > e) { showMessage('开始日期不能大于截止日期', 'error'); return; }
                loadProducts(1);
            }

            function resetSearch() {
                ['searchInput','searchProductDesc','searchSalesperson','dateStart','dateEnd']
                  .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
                loadProducts(1);
            }

            function displayPagination(current, total) {
                const pagination = document.getElementById('pagination');
                pagination.innerHTML = '';
                if (total <= 1) return;
                const add = (disabled, text, page) => {
                    const li = document.createElement('li');
                    li.className = `page-item ${disabled ? 'disabled' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#">${text}</a>`;
                    if (!disabled) li.querySelector('a').onclick = () => loadProducts(page);
                    pagination.appendChild(li);
                };
                add(current === 1, '上一页', current - 1);
                for (let i = 1; i <= total; i++) {
                    if (i === 1 || i === total || (i >= current - 2 && i <= current + 2)) {
                        const li = document.createElement('li');
                        li.className = `page-item ${i === current ? 'active' : ''}`;
                        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                        if (i !== current) li.querySelector('a').onclick = () => loadProducts(i);
                        pagination.appendChild(li);
                    } else if (i === current - 3 || i === current + 3) {
                        const li = document.createElement('li'); li.className = 'page-item disabled';
                        li.innerHTML = '<span class="page-link">...</span>'; pagination.appendChild(li);
                    }
                }
                add(current === total, '下一页', current + 1);
                // 清理可能遗留的两个分页条（旧节点）
                const pagers = document.querySelectorAll('.grid-card nav.pager-bar');
                if (pagers.length > 1) {
                    for (let i = 0; i < pagers.length - 1; i++) {
                        pagers[i].remove();
                    }
                }
            }

            function renderRows(products) {
                const tbody = document.getElementById('productTableBody');
                tbody.innerHTML = '';
                if (!products.length) { tbody.innerHTML = '<tr><td colspan="22" class="text-center">暂无数据</td></tr>'; return; }
                products.forEach(p => {
                    const docDate = p.doc_date || (p.create_time || '').slice(0,10);
                    const unitPrice = Number(p.unit_price ?? p.price ?? 0);
                    const qty = Number(p.quantity ?? 0);
                    const unitRate = Number(p.unit_discount_rate ?? 100);
                    const priceDiscounted = unitPrice * unitRate / 100.0;
                    const amount = (p.amount != null) ? Number(p.amount) : priceDiscounted * qty;
                    const orderRate = Number(p.order_discount_rate ?? 100);
                    const amountDiscounted = (p.amount_discounted != null) ? Number(p.amount_discounted) : amount * orderRate / 100.0;
                    const freight = Number(p.freight ?? 0);
                    const receivable = (p.receivable != null) ? Number(p.receivable) : (amountDiscounted + freight);
                    const paidTotal = Number(p.paid_total ?? 0);
                    const balance = (p.balance != null) ? Number(p.balance) : (receivable - paidTotal);

                    const unit = p.unit || p.spec || '';
                    const tr = document.createElement('tr');
                    tr.dataset.id = p.id;
                    tr.innerHTML = `
                        <td class="editable">${editableInput('doc_date', docDate, 'date')}</td>
                        <td class="editable">${editableInput('customer_name', p.customer_name || p.name || '')}</td>
                        <td class="editable">${editableInput('product_desc', p.product_desc || '')}</td>
                        <td class="editable">${editableInput('unit', unit)}</td>
                        <td class="editable">${editableInput('quantity', qty, 'number')}</td>
                        <td class="editable">${editableInput('unit_price', unitPrice, 'number', { step: '0.01' })}</td>
                        <td class="editable">${editableInput('unit_discount_rate', unitRate, 'number', { step: '0.01' })}</td>
                        <td>${(unitPrice * unitRate / 100.0).toFixed(2)}</td>
                        <td>${amount.toFixed(2)}</td>
                        <td class="editable">${editableInput('remark', p.remark || '')}</td>
                        <td class="editable">${editableInput('freight', freight, 'number', { step: '0.01' })}</td>
                        <td class="editable">${editableInput('order_discount_rate', orderRate, 'number', { step: '0.01' })}</td>
                        <td>${amountDiscounted.toFixed(2)}</td>
                        <td>${receivable.toFixed(2)}</td>
                        <td class="editable">${editableInput('paid_total', paidTotal, 'number', { step: '0.01' })}</td>
                        <td>${balance.toFixed(2)}</td>
                        <td class="editable">${editableInput('settlement_account', p.settlement_account || '')}</td>
                        <td class="editable">${editableInput('description', p.description || '')}</td>
                        <td>${p.salesperson || ''}</td>
                        <td>${p.update_time || ''}</td>
                        <td>${p.create_time || ''}</td>
                    `;
                    tbody.appendChild(tr);
                });
                // 绑定变更事件
                tbody.querySelectorAll('input[data-field]').forEach(inp => {
                    inp.addEventListener('change', onCellChange);
                    inp.addEventListener('input', markRowDirtyOnInput);
                });
            }

            function editableInput(field, value, type = 'text', attrs = {}) {
                const attrStr = Object.entries(attrs).map(([k,v]) => `${k}="${v}"`).join(' ');
                const val = (value == null) ? '' : value;
                return `<input class="form-control form-control-sm" data-field="${field}" type="${type}" ${attrStr} value="${escapeHtml(String(val))}">`;
            }

            function escapeHtml(str) { return str.replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])); }

            function onCellChange(e) {
                const input = e.target;
                const tr = input.closest('tr');
                const id = Number(tr.dataset.id);
                const field = input.dataset.field;
                let val = input.value;
                if (input.type === 'number') val = (val === '' ? null : Number(val));
                if (input.type === 'date') val = val || null;
                const prev = dirtyMap.get(id) || {};
                prev[field] = val;
                dirtyMap.set(id, prev);
                tr.classList.add('changed');
            }

            function markRowDirtyOnInput(e) {
                const tr = e.target.closest('tr');
                tr?.classList.add('changed');
            }

            function saveAllChanges() {
                if (dirtyMap.size === 0) { showMessage('没有需要保存的修改', 'warning'); return; }
                const items = Array.from(dirtyMap.entries()).map(([id, fields]) => ({ id, fields }));
                fetch('/product/batch_update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items })
                })
                .then(r => r.json())
                .then(d => {
                    if (!d.success) return showMessage(d.message || '保存失败', 'error');
                    showMessage(`保存完成：成功 ${d.data.success_count} 条，失败 ${d.data.fail_count} 条`, 'success');
                    dirtyMap.clear();
                    loadProducts(currentPage);
                })
                .catch(err => showMessage('保存失败: ' + err.message, 'error'));
            }

            // 计算 & 格式化
            function num(n){ const v = Number(n); return Number.isFinite(v) ? v : 0; }
            function calcUnitPriceDiscounted(d){ return num(d.unit_price) * (num(d.unit_discount_rate) || 100) / 100.0; }
            function calcAmount(d){ return calcUnitPriceDiscounted(d) * num(d.quantity); }
            function calcAmountDiscounted(d){ return calcAmount(d) * (num(d.order_discount_rate) || 100) / 100.0; }
            function calcReceivable(d){ return calcAmountDiscounted(d) + num(d.freight); }
            function calcBalance(d){ return calcReceivable(d) - num(d.paid_total); }
            function toFixed2(x){ return num(x).toFixed(2); }
            function decimal2(cell){ const v = cell.getValue(); return toFixed2(v); }

            // ========== 降级渲染（无 Tabulator 时） ==========
            function initFallbackGrid(){
                const holder = document.getElementById('grid');
                const cols = (typeof getActiveColumns === 'function' ? getActiveColumns() : []).filter(c => !c.hidden);
                const head = cols.map(c => `<th class="col-${c.key}">${c.title}</th>`).join('');
                holder.innerHTML = `<div class="table-responsive"><table class="table table-striped align-middle table-nowrap" id="fallbackTable"><thead><tr>${head}<th class="col-actions">操作</th></tr></thead><tbody></tbody></table></div>`;
            }

            function gridReplaceData(rows){
                if (!useFallback) { grid.replaceData(rows); return; }
                const cols = (typeof getActiveColumns === 'function' ? getActiveColumns() : []).filter(c => !c.hidden);
                const tbody = document.querySelector('#fallbackTable tbody');
                tbody.innerHTML = '';
                // 同步缓存
                rowCache = new Map(rows.map(x => [x.id, { ...x }]));
                rows.forEach(d => {
                    const tr = document.createElement('tr');
                    tr.setAttribute('data-id', d.id);
                    const unit = d.unit || '';
                    const imgHtml = d.image_path ? `<img src="/uploads/thumb_${d.image_path}" class="thumb-fixed" onclick="openImageModalById(${d.id})">` : `<button class=\"btn btn-sm btn-outline-primary\" onclick=\"openImageModalById(${d.id})\">添加图片</button>`;
                    const cellMap = {
                        doc_date: `<input class=\"form-control form-control-sm\" type=\"date\" data-field=\"doc_date\" value=\"${(d.doc_date||'').slice(0,10)}\" data-prev=\"${(d.doc_date||'').slice(0,10)}\">`,
                        customer_name: `<input class=\"form-control form-control-sm\" data-field=\"customer_name\" value=\"${escapeHtml(d.customer_name||d.name||'')}\" data-prev=\"${escapeHtml(d.customer_name||d.name||'')}\">`,
                        product_desc: `<input class=\"form-control form-control-sm\" data-field=\"product_desc\" value=\"${escapeHtml(d.product_desc||d.name||'')}\" data-prev=\"${escapeHtml(d.product_desc||d.name||'')}\">`,
                        name: `<input class=\"form-control form-control-sm\" data-field=\"product_desc\" value=\"${escapeHtml(d.product_desc||d.name||'')}\" data-prev=\"${escapeHtml(d.product_desc||d.name||'')}\">`,
                        unit: `<input class=\"form-control form-control-sm\" data-field=\"unit\" value=\"${escapeHtml(unit)}\" data-prev=\"${escapeHtml(unit)}\">`,
                        quantity: `<input class=\"form-control form-control-sm\" type=\"number\" data-field=\"quantity\" value=\"${Number(d.quantity||0)}\" data-prev=\"${Number(d.quantity||0)}\">`,
                        unit_price: `<input class=\"form-control form-control-sm\" type=\"number\" step=\"0.01\" data-field=\"unit_price\" value=\"${Number(d.unit_price||0)}\" data-prev=\"${Number(d.unit_price||0)}\">`,
                        unit_discount_rate: `<input class=\"form-control form-control-sm\" type=\"number\" step=\"0.01\" data-field=\"unit_discount_rate\" value=\"${Number(d.unit_discount_rate||100)}\" data-prev=\"${Number(d.unit_discount_rate||100)}\">`,
                        unit_price_discounted: toFixed2(calcUnitPriceDiscounted(d)),
                        amount: toFixed2(calcAmount(d)),
                        image_path: `${imgHtml}`,
                        image: `${imgHtml}`,
                        remark: `<input class=\"form-control form-control-sm\" data-field=\"remark\" value=\"${escapeHtml(d.remark||'')}\">`,
                        freight: `<input class=\"form-control form-control-sm\" type=\"number\" step=\"0.01\" data-field=\"freight\" value=\"${Number(d.freight||0)}\">`,
                        order_discount_rate: `<input class=\"form-control form-control-sm\" type=\"number\" step=\"0.01\" data-field=\"order_discount_rate\" value=\"${Number(d.order_discount_rate||100)}\">`,
                        amount_discounted: toFixed2(calcAmountDiscounted(d)),
                        receivable: toFixed2(calcReceivable(d)),
                        paid_total: `<input class=\"form-control form-control-sm\" type=\"number\" step=\"0.01\" data-field=\"paid_total\" value=\"${Number(d.paid_total||0)}\">`,
                        balance: toFixed2(calcBalance(d)),
                        settlement_account: `<input class=\"form-control form-control-sm\" data-field=\"settlement_account\" value=\"${escapeHtml(d.settlement_account||'')}\">`,
                        description: `<input class=\"form-control form-control-sm\" data-field=\"description\" value=\"${escapeHtml(d.description||'')}\">`,
                        salesperson: (d.salesperson||''),
                        update_time: (d.update_time||''),
                        create_time: (d.create_time||'')
                    };
                    const opsHtml = `<td class=\"col-actions\"><button class=\"btn btn-outline-danger btn-sm\" onclick=\"deleteProduct(${d.id})\"><i class='bi bi-trash'></i></button></td>`;
                    tr.innerHTML = cols.map(c => `<td class=\"col-${c.key}\">${cellMap[c.key]||''}</td>`).join('') + opsHtml;
                    tbody.appendChild(tr);
                });
                tbody.querySelectorAll('input[data-field]').forEach(inp => {
                    inp.addEventListener('change', function(e){
                        const tr = e.target.closest('tr');
                        const id = Number(tr.getAttribute('data-id'));
                        const field = e.target.getAttribute('data-field');
                        let val = e.target.value;
                        if (e.target.type === 'number') val = (val === '' ? null : Number(val));
                        if (e.target.type === 'date') val = val || null;
                        const prevVal = e.target.getAttribute('data-prev');
                        e.target.disabled = true;
                        // 先本地刷新计算列
                        const cur = rowCache.get(id) || {};
                        cur[field] = val;
                        rowCache.set(id, cur);
                        refreshFallbackComputed(tr, { ...cur });
                        savePartialUpdate(id, { [field]: val })
                          .then(() => {
                              const cache = rowCache.get(id) || {};
                              cache[field] = val;
                              rowCache.set(id, cache);
                              tr.classList.add('changed');
                              e.target.setAttribute('data-prev', (e.target.value || ''));
                          })
                          .catch(err => {
                              showMessage('保存失败: ' + (err.message || err), 'error');
                              // 回滚输入框值
                              if (prevVal !== null) {
                                  e.target.value = prevVal;
                              }
                              // 回滚计算列
                              const cache = rowCache.get(id) || {};
                              cache[field] = (e.target.type === 'number') ? (prevVal === '' ? null : Number(prevVal)) : prevVal;
                              rowCache.set(id, cache);
                              refreshFallbackComputed(tr, { ...cache });
                          })
                          .finally(() => { e.target.disabled = false; });
                    });
                });
            }

            function refreshFallbackComputed(tr, d){
                try{
                    const id = Number(tr.getAttribute('data-id'));
                    const base = rowCache.get(id) || {};
                    const data = Object.assign({}, base, d || {});
                    const u = Number(data.unit_price ?? 0);
                    const r = (data.unit_discount_rate == null || data.unit_discount_rate === '') ? 100 : Number(data.unit_discount_rate);
                    const q = Number(data.quantity ?? 0);
                    const o = (data.order_discount_rate == null || data.order_discount_rate === '') ? 100 : Number(data.order_discount_rate);
                    const f = Number(data.freight ?? 0);
                    const p = Number(data.paid_total ?? 0);
                    const cell = (cls) => tr.querySelector('td.col-'+cls);
                    const unitPriceDiscounted = (u * ((r || 100)) / 100.0);
                    const amount = unitPriceDiscounted * q;
                    const amountDiscounted = amount * ((o || 100)) / 100.0;
                    const receivable = amountDiscounted + f;
                    const balance = receivable - p;
                    const setText = (el, v) => { if (el) el.textContent = toFixed2(v); };
                    setText(cell('unit_price_discounted'), unitPriceDiscounted);
                    setText(cell('amount'), amount);
                    setText(cell('amount_discounted'), amountDiscounted);
                    setText(cell('receivable'), receivable);
                    setText(cell('balance'), balance);
                }catch(e){}
            }

            async function syncColumnsFromServer(){
                try{
                    const resp = await fetch('/product/columns/load');
                    const data = await resp.json();
                    if (data && data.success && Array.isArray(data.data) && data.data.length){
                        const normalized = data.data.map(c => ({ key: normalizeKey(c.key), checked: !!c.checked }));
                        localStorage.setItem('edit_columns', JSON.stringify(normalized.map(c => ({ key:c.key, title:(BASE_COLUMNS.find(d=>d.key===c.key)||{}).title || c.key, hidden: !c.checked }))));
                    } else {
                        localStorage.removeItem('edit_columns');
                    }
                }catch(e){ /* ignore; fallback to default */ }
            }

            function collectRowData(tr){
                const get = f => { const el = tr.querySelector(`[data-field="${f}"]`); if (!el) return undefined; if (el.type==='number') return Number(el.value||0); return el.value; };
                return {
                    unit_price: Number(get('unit_price')||0),
                    unit_discount_rate: Number(get('unit_discount_rate')||100),
                    quantity: Number(get('quantity')||0),
                    order_discount_rate: Number(get('order_discount_rate')||100),
                    freight: Number(get('freight')||0),
                    paid_total: Number(get('paid_total')||0)
                };
            }

            function getRow(id){
                if (!useFallback) return grid.getRow(id);
                const tr = document.querySelector(`#fallbackTable tr[data-id="${id}"]`);
                if (!tr) return null;
                return {
                    update: function(patch){
                        if (Object.prototype.hasOwnProperty.call(patch,'image_path')){
                            const td = tr.querySelector('td.col-image_path, td.col-image') || tr.children[0];
                            const old = td.querySelector('img');
                            if (old) old.remove();
                            if (patch.image_path){
                                td.innerHTML = '';
                                td.insertAdjacentHTML('afterbegin', `<img src="/uploads/thumb_${patch.image_path}" class=\"thumb-fixed\" onclick=\"openImageModalById(${id})\">`);
                            } else {
                                td.innerHTML = '';
                                td.insertAdjacentHTML('afterbegin', '<button class="btn btn-sm btn-outline-primary" onclick="openImageModalById('+id+')">添加图片</button>');
                            }
                        }
                    }
                };
            }

            function resetChanges() {
                dirtyMap.clear();
                loadProducts(currentPage);
            }

            function showMessage(message, type = 'info') {
                const toast = document.getElementById('messageToast');
                const toastMessage = document.getElementById('toastMessage');
                toastMessage.textContent = message;
                toast.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');
                switch (type) {
                    case 'success': toast.classList.add('bg-success', 'text-white'); break;
                    case 'error': toast.classList.add('bg-danger', 'text-white'); break;
                    case 'warning': toast.classList.add('bg-warning'); break;
                    default: toast.classList.add('bg-info', 'text-white');
                }
                new bootstrap.Toast(toast).show();
            }

            function logout() {
                fetch('/auth/logout', { method: 'POST' })
                    .then(r => r.json())
                    .then(() => { window.location.href = '/auth/login'; })
                    .catch(() => { window.location.href = '/auth/login'; });
            }

            // 导出：使用当前查询条件 + 用户列配置，调用后端现有导出接口
            function exportCurrent(){
                // 列顺序与勾选：优先本地（已是服务端保存结果）
                let cfg = [];
                try { cfg = JSON.parse(localStorage.getItem('edit_columns') || '[]'); } catch(e) { cfg = []; }
                if (!Array.isArray(cfg) || cfg.length === 0) { cfg = BASE_COLUMNS.map(c => ({ key: c.key, hidden: false })); }
                // 兼容两种结构：{checked} 或 {hidden}
                const selectedInternalKeys = cfg
                    .filter(c => c && (c.checked === true || c.checked === undefined && c.hidden !== true))
                    .map(c => c.key);
                if (selectedInternalKeys.length === 0) { showMessage('请至少选择一列在列设置中启用', 'error'); return; }
                // 内部键映射到导出接口键
                const toExportKey = (k) => (k === 'product_desc' ? 'name' : (k === 'image_path' ? 'image' : k));
                const selected = selectedInternalKeys.map(toExportKey);

                const filters = {
                    search: document.getElementById('searchInput').value || undefined,
                    product_desc: document.getElementById('searchProductDesc').value || undefined,
                    salesperson: document.getElementById('searchSalesperson').value || undefined,
                    date_start: document.getElementById('dateStart').value || undefined,
                    date_end: document.getElementById('dateEnd').value || undefined
                };

                fetch('/product/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ columns: selected, filters })
                })
                    .then(response => {
                        if (!response.ok) throw new Error('导出失败');
                        const cd = response.headers.get('Content-Disposition');
                        let filename = '';
                        if (cd) {
                            const m = cd.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                            if (m && m[1]) filename = m[1].replace(/['"]/g, '');
                        }
                        if (!filename) filename = `products_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.xlsx`;
                        return response.blob().then(blob => ({ blob, filename }));
                    })
                    .then(({ blob, filename }) => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url; a.download = filename; document.body.appendChild(a); a.click();
                        URL.revokeObjectURL(url); a.remove();
                        showMessage('导出成功', 'success');
                    })
                    .catch(err => showMessage('导出失败: ' + (err.message || err), 'error'));
            }
        </script>
    </body>
</html>


